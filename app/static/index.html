<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnel Information System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { 
            overflow-x: hidden; 
            padding-top: 60px;
        }
        #list-pane .table-responsive { 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        #list-pane .table-responsive::-webkit-scrollbar {
            height: 8px;
        }
        #list-pane .table-responsive::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.35);
            border-radius: 4px;
        }
        #staffTable {
            width: max-content;
            min-width: 100%;
        }
        #staffTable th,
        #staffTable td {
            white-space: nowrap;
        }
        
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .form-label { font-weight: 500; }
        .required:after { content: " *"; color: red; }
        .nav-link { cursor: pointer; }
        .small-font { font-size: 0.85em; }
        
        /* Responsive Adjustments */
        @media (max-width: 767.98px) {
            .table { font-size: 0.8rem; }
            h1.display-4 { font-size: 2.5rem; }
            .btn-group-sm > .btn, .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .card-body { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Global Loader & Debug -->
    <div id="global-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="global-loader-text" class="mt-3 fw-bold text-dark">Initializing Application...</div>
        <div id="loader-debug-info" class="mt-2 text-muted small"></div>
        <button class="btn btn-sm btn-outline-danger mt-4" onclick="document.getElementById('global-loader').style.display='none'">Force Close Loader</button>
    </div>

    <script>
        // Global Error Handler
        window.onerror = function(msg, url, line, col, error) {
            var extra = !col ? '' : '\ncolumn: ' + col;
            extra += !error ? '' : '\nerror: ' + error;
            var message = "Error: " + msg + "\nurl: " + url + "\nline: " + line + extra;
            console.error(message);
            
            // Show on loader if visible
            var debugInfo = document.getElementById('loader-debug-info');
            if (debugInfo) debugInfo.innerText = "Error: " + msg;
            
            // Alert only if critical
            // alert(message); 
            return false;
        };

        // Early Auth Check
        (function() {
            try {
                var token = localStorage.getItem('token');
                var isLoginPage = window.location.pathname.indexOf('login.html') !== -1;
                
                if (!token || token === 'null' || token === 'undefined') {
                    if (!isLoginPage) {
                        console.warn("No valid token, redirecting to login.");
                        window.location.replace('/login.html');
                    }
                } else {
                    console.log("Token found, proceeding.");
                }
            } catch (e) {
                console.error("Auth check failed:", e);
            }
        })();
    </script>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">V/R</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('dashboard')"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
                    </li>
                    <li class="nav-item dropdown" id="nav-personnel">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-people-fill me-1"></i> Personnel
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showPersonnelTab('list-tab')">Personnel List</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showPersonnelTab('form-tab')">Add New</a></li>
                            <li><a class="dropdown-item admin-only" href="#" onclick="showPersonnelTab('import-tab')">Bulk Import</a></li>
                            <li><a class="dropdown-item admin-only super-only" href="#" onclick="showPersonnelTab('privileges-tab')">Privileges</a></li>
                            <li><a class="dropdown-item admin-only" href="#" onclick="showPersonnelTab('password-reset-tab')">Password Reset</a></li>
                        </ul>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#" onclick="showView('offices')"><i class="bi bi-building me-1"></i> Offices</a>
                    </li>
                    <li class="nav-item" id="nav-leave">
                        <a class="nav-link" href="#" onclick="showView('leave')"><i class="bi bi-calendar-check me-1"></i> Leave</a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#" onclick="showView('audit')"><i class="bi bi-journal-text me-1"></i> Audit Log</a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#" onclick="showView('approvals')">
                            <i class="bi bi-check2-square me-1"></i> Authorizations
                            <span class="badge bg-danger ms-1 d-none" id="approvalsCounter">0</span>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i> <span id="userDisplayNavbar">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="openChangePasswordModal()">Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
             <h4 class="mb-0" id="pageTitle">Dashboard</h4>
        </div>
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card text-white bg-primary mb-3 cursor-pointer" onclick="showView('personnel')" style="cursor: pointer;">
                                <div class="card-header" id="dash-card1-title">Total Personnel</div>
                                <div class="card-body">
                                    <h1 class="card-title display-4 fw-bold" id="dash-total-staff">0</h1>
                                    <p class="card-text">Click to view list</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-success mb-3 cursor-pointer" onclick="showView('offices')" style="cursor: pointer;">
                                <div class="card-header" id="dash-card2-title">Total Offices</div>
                                <div class="card-body">
                                    <h1 class="card-title display-4 fw-bold" id="dash-total-offices">0</h1>
                                    <p class="card-text" id="dash-card2-text">Click to view offices</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">Rank Summary</div>
                                <div class="card-body">
                                    <canvas id="rankSummaryChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personnel View -->
                <div id="view-personnel" class="view-section d-none">
                    <ul class="nav nav-tabs mb-3" id="personnelTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button">Personnel List</button>
                        </li>
                        <li class="nav-item d-none" role="presentation">
                            <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button">Add / Edit Personnel</button>
                        </li>
                        <li class="nav-item admin-only d-none" role="presentation">
                            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-pane" type="button">Bulk Import</button>
                        </li>
                        <li class="nav-item admin-only super-only d-none" role="presentation">
                            <button class="nav-link" id="privileges-tab" data-bs-toggle="tab" data-bs-target="#privileges-pane" type="button">Privileges</button>
                        </li>
                        <li class="nav-item admin-only d-none" role="presentation">
                            <button class="nav-link" id="password-reset-tab" data-bs-toggle="tab" data-bs-target="#password-reset-pane" type="button">Password Reset</button>
                        </li>
                        <li class="nav-item admin-only d-none" role="presentation">
                            <button class="nav-link" id="edit-requests-tab" data-bs-toggle="tab" data-bs-target="#edit-requests-pane" type="button">Edit Approvals</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="personnelTabContent">
                        <!-- List Pane -->
                        <div class="tab-pane fade show active" id="list-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <ul class="nav nav-pills mb-3" id="mainStatusTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" href="#" onclick="setMainStatus('active', this)">Active Personnel</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" onclick="setMainStatus('exited', this)">Posted Out / Exited</a>
                                        </li>
                                    </ul>
                                    <div class="row mb-3 g-2">
                                        <div class="col-12 col-md-3">
                                            <input type="text" id="searchInput" class="form-control" placeholder="Search surname, NIS...">
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <div class="dropdown" id="filterRankDropdown">
                                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start text-truncate" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="filterRankBtn">
                                                    All Ranks
                                                </button>
                                                <ul class="dropdown-menu p-2" style="max-height: 300px; overflow-y: auto; width: 250px;">
                                                    <li><input type="text" class="form-control form-control-sm mb-2" placeholder="Search..." onkeyup="filterDropdown(this)"></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <div id="filterRankContainer">
                                                        <!-- Checkboxes go here -->
                                                    </div>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <div class="dropdown" id="filterOfficeDropdown">
                                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start text-truncate" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="filterOfficeBtn">
                                                    All Offices
                                                </button>
                                                <ul class="dropdown-menu p-2" style="max-height: 300px; overflow-y: auto; width: 250px;">
                                                     <li><input type="text" class="form-control form-control-sm mb-2" placeholder="Search..." onkeyup="filterDropdown(this)"></li>
                                                     <li><hr class="dropdown-divider"></li>
                                                     <div id="filterOfficeContainer">
                                                        <!-- Checkboxes go here -->
                                                     </div>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <select id="sortDopp" class="form-select" onchange="loadStaff()">
                                                <option value="">Sort by DOPP</option>
                                                <option value="asc">DOPP Ascending</option>
                                                <option value="desc">DOPP Descending</option>
                                            </select>
                                        </div>
                                        <div class="col-6 col-md-2 exited-only d-none">
                                            <input type="text" id="exitFrom" class="form-control date-picker" placeholder="Eff. Date From">
                                        </div>
                                        <div class="col-6 col-md-2 exited-only d-none">
                                            <input type="text" id="exitTo" class="form-control date-picker" placeholder="Eff. Date To">
                                        </div>
                                        <div class="col-12 col-md-1">
                                            <button class="btn btn-primary w-100" onclick="loadStaff()"><i class="bi bi-search"></i></button>
                                        </div>
                                        <div class="col-12 col-md-2">
                                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()"><i class="bi bi-x-circle"></i> Clear Filters</button>
                                        </div>
                                        <div class="col-6 col-md-2 text-md-end">
                                            <button class="btn btn-success w-100" onclick="showAddForm()"><i class="bi bi-plus-lg"></i> Add</button>
                                        </div>
                                        <div class="col-6 col-md-2 text-md-end">
                                            <div class="btn-group w-100">
                                                <button class="btn btn-success btn-sm w-50" onclick="openExportModal('excel')"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                                                <button class="btn btn-danger btn-sm w-50" onclick="openExportModal('pdf')"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                                            </div>
                                        </div>
                                    </div>

                                    <ul class="nav nav-tabs mb-3" id="statusTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" href="#" onclick="setStatusFilter('completed', this)">Completed</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" onclick="setStatusFilter('incomplete', this)">Incomplete</a>
                                        </li>
                                    </ul>

                                    <div class="table-responsive">
                                        <table id="staffTable" class="table table-hover align-middle" style="width:max-content;min-width:100%">
                                            <thead class="table-light" id="staffTableHead">
                                            </thead>
                                            <tbody id="staffTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Pane -->
                        <div class="tab-pane fade" id="form-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0" id="formTitle">Add New Personnel</h5>
                                </div>
                                <div class="card-body">
                                    <form id="staffForm">
                                        <input type="hidden" id="staffId">
                                        
                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Personal Details</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label required">NIS/No</label>
                                                        <input type="text" class="form-control" id="nis_no" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label required">Surname</label>
                                                        <input type="text" class="form-control" id="surname" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label required">Other Names</label>
                                                        <input type="text" class="form-control" id="other_names" required>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Gender</label>
                                                        <select class="form-select" id="gender">
                                                            <option value="">Select...</option>
                                                            <option value="Male">Male</option>
                                                            <option value="Female">Female</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">DOB</label>
                                                        <input type="text" class="form-control date-picker" id="dob" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Phone No</label>
                                                        <input type="text" class="form-control" id="phone_no">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Email</label>
                                                        <input type="email" class="form-control" id="email">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Qualification</label>
                                                        <select class="form-select" id="qualification">
                                                            <option value="">Select...</option>
                                                            <option value="B.Sc">B.Sc</option>
                                                            <option value="B.A">B.A</option>
                                                            <option value="B.Ed">B.Ed</option>
                                                            <option value="B.Tech">B.Tech</option>
                                                            <option value="M.Sc">M.Sc</option>
                                                            <option value="M.Tech">M.Tech</option>
                                                            <option value="PhD">PhD</option>
                                                            <option value="HND">HND</option>
                                                            <option value="ND">ND</option>
                                                            <option value="SSCE">SSCE</option>
                                                            <option value="MBA">MBA</option>
                                                            <option value="MPA">MPA</option>
                                                            <option value="PGD">PGD</option>
                                                            <option value="NCE">NCE</option>
                                                            <option value="LLB">LLB</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Official Info</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label required">Rank</label>
                                                        <select class="form-select" id="rank" required>
                                                            <option value="">Select...</option>
                                                            </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Office</label>
                                                        <select class="form-select" id="office">
                                                            <option value="">Select...</option>
                                                            </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">DOFA</label>
                                                        <input type="text" class="form-control date-picker" id="dofa" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">DOPA</label>
                                                        <input type="text" class="form-control date-picker" id="dopa" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">DOPP</label>
                                                        <input type="text" class="form-control date-picker" id="dopp" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Origin & Kin</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">State of Origin</label>
                                                        <select class="form-select" id="state_id" onchange="loadLGAs(this.value)">
                                                            <option value="">Select State...</option>
                                                            </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">LGA</label>
                                                        <select class="form-select" id="lga_id" disabled>
                                                            <option value="">Select State First</option>
                                                            </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Home Town</label>
                                                        <input type="text" class="form-control" id="home_town">
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Next of Kin Name</label>
                                                        <input type="text" class="form-control" id="next_of_kin">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Next of Kin Phone</label>
                                                        <input type="text" class="form-control" id="nok_phone">
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Remark</label>
                                                    <textarea class="form-control" id="remark" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" onclick="showList()">Cancel</button>
                                            <button type="submit" class="btn btn-primary px-4">Save Personnel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Import Pane -->
                        <div class="tab-pane fade" id="import-pane" role="tabpanel">
                             <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Bulk Import</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row justify-content-center py-5">
                                        <div class="col-md-8 text-center">
                                            <div class="mb-4">
                                                <i class="bi bi-database-add text-success" style="font-size: 4rem;"></i>
                                                <p class="mt-2 text-muted">Upload an Excel (.xlsx, .xls) or MS Access (.accdb, .mdb) file.</p>
                                            </div>
                                            <div class="input-group mb-3">
                                                <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls, .accdb, .mdb">
                                                <button class="btn btn-primary" type="button" onclick="uploadExcel()">Upload & Import</button>
                                            </div>
                                            <div class="mb-4">
                                                <a href="/download/template" class="btn btn-outline-secondary btn-sm">
                                                    <i class="bi bi-download"></i> Download Excel Template
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="importResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                         <!-- Privileges Pane (Moved from Modal to here, or keep as separate tab) -->
                        <div class="tab-pane fade super-only" id="privileges-pane" role="tabpanel">
                            <div class="card mb-3">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Staff Self-Edit Controls</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="globalAllowEditRank" onchange="updateStaffEditSettings()">
                                                <label class="form-check-label" for="globalAllowEditRank">Allow all staff users to edit Rank</label>
                                            </div>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" id="globalAllowEditDopp" onchange="updateStaffEditSettings()">
                                                <label class="form-check-label" for="globalAllowEditDopp">Allow all staff users to edit DOPP</label>
                                            </div>
                                            <small class="text-muted" id="staffEditSettingsStatus"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Manage User Privileges</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Rank</th>
                                                    <th>Current Role</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="privilegesTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Password Reset Pane -->
                        <div class="tab-pane fade" id="password-reset-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Reset User Passwords</h5>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <input type="text" id="resetSearchInput" class="form-control" placeholder="Search surname, NIS...">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" onclick="loadResetList()"><i class="bi bi-search"></i> Search</button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Rank</th>
                                                    <th>Office</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resetTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="edit-requests-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Pending Edit Requests</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="loadEditRequests()">Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>S/N</th>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Changes</th>
                                                    <th>Requested At</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="editRequestsBodyInline"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Offices View -->
                <div id="view-offices" class="view-section d-none">
                    <div class="card">
                         <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Offices Directory</h5>
                            <button class="btn btn-success" onclick="openOfficeModal()">
                                <i class="bi bi-plus-lg"></i> Add Office
                            </button>
                         </div>
                         <div class="card-body">
                             <div class="table-responsive">
                                 <table class="table table-hover align-middle">
                                     <thead class="table-light">
                                         <tr>
                                             <th>Office Name</th>
                                             <th style="width: 200px;">Actions</th>
                                         </tr>
                                     </thead>
                                     <tbody id="officesTableBody">
                                     </tbody>
                                 </table>
                             </div>
                             <hr>
                            <div class="mt-3">
                                <h6 id="officeSummaryTitle" class="mb-2 d-none"></h6>
                                <canvas id="officeSummaryChart" style="max-height: 130px; width: 100%;"></canvas>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Leave View -->
                <div id="view-leave" class="view-section d-none">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Leave Requests</h5>
                            <button class="btn btn-primary" onclick="openLeaveModal()">
                                <i class="bi bi-plus-lg"></i> Apply for Leave
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Staff Name</th>
                                            <th>Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Reason</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaveTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-audit" class="view-section d-none">
                     <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">System Audit Log</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Action</th>
                                            <th>Target</th>
                                            <th>Details</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-approvals" class="view-section d-none">
                    <div class="row">
                        <div class="col-lg-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        Edit Requests
                                        <span class="badge bg-primary ms-1 d-none" id="editRequestsCounter">0</span>
                                    </h5>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="loadEditRequests()">Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>S/N</th>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Changes</th>
                                                    <th>Requested At</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="editRequestsBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        Exit Requests
                                        <span class="badge bg-danger ms-1 d-none" id="exitRequestsCounter">0</span>
                                    </h5>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="loadExitRequests()">Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>S/N</th>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Office</th>
                                                    <th>Requested Exit</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="exitRequestsBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success View -->
                <div id="view-success" class="view-section d-none">
                    <div class="card border-success">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                            <h2 class="mt-4">Update Successful!</h2>
                            <p class="lead text-muted">Your personnel information has been saved successfully.</p>
                            <div class="mt-4">
                                <button class="btn btn-primary px-4 me-2" onclick="showPersonnelTab('form-tab'); editStaff(userId)">Continue Editing</button>
                                <button class="btn btn-outline-danger px-4" onclick="logout()">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Office Modal -->
    <div class="modal fade" id="officeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="officeModalTitle">Add Office</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="officeId">
                    <div class="mb-3">
                        <label class="form-label required">Office Name</label>
                        <input type="text" class="form-control" id="officeName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOffice()">Save Office</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div class="modal fade" id="leaveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="leaveForm">
                        <div class="mb-3 d-none" id="leaveStaffSelectDiv">
                            <label class="form-label">Select Personnel</label>
                            <select class="form-select" id="leaveStaffId">
                                <option value="">Select Personnel...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Leave Type</label>
                            <select class="form-select" id="leaveType" required>
                                <option value="Annual">Annual Leave</option>
                                <option value="Casual">Casual Leave</option>
                                <option value="Sick">Sick Leave</option>
                                <option value="Compassionate">Compassionate Leave</option>
                                <option value="Maternity">Maternity Leave</option>
                                <option value="Paternity">Paternity Leave</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="text" class="form-control date-picker" id="leaveStartDate" required placeholder="dd/mm/yyyy">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="text" class="form-control date-picker" id="leaveEndDate" required placeholder="dd/mm/yyyy">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <textarea class="form-control" id="leaveReason" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitLeave()">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Columns Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Columns to Export</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2">Check to include, use arrows to reorder.</p>
                    <ul class="list-group" id="exportColumnList">
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="nis_no" checked>
                            <span class="flex-grow-1">NIS No</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="surname" checked>
                            <span class="flex-grow-1">Surname</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="other_names" checked>
                            <span class="flex-grow-1">Other Names</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="rank" checked>
                            <span class="flex-grow-1">Rank</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="gender" checked>
                            <span class="flex-grow-1">Gender</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="office" checked>
                            <span class="flex-grow-1">Office</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="state" checked>
                            <span class="flex-grow-1">State</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="lga" checked>
                            <span class="flex-grow-1">LGA</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="phone_no" checked>
                            <span class="flex-grow-1">Phone No</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="email">
                            <span class="flex-grow-1">Email</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="qualification">
                            <span class="flex-grow-1">Qualification</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="dob">
                            <span class="flex-grow-1">Date of Birth</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="dofa" checked>
                            <span class="flex-grow-1">DOFA</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="dopa" checked>
                            <span class="flex-grow-1">DOPA</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="dopp">
                            <span class="flex-grow-1">DOPP</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="home_town">
                            <span class="flex-grow-1">Home Town</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="next_of_kin">
                            <span class="flex-grow-1">Next of Kin</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="nok_phone">
                            <span class="flex-grow-1">Next of Kin Phone</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" value="remark">
                            <span class="flex-grow-1">Remark</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, -1)"><i class="bi bi-arrow-up"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="moveColumn(this, 1)"><i class="bi bi-arrow-down"></i></button>
                            </div>
                        </li>
                    </ul>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="merge_name" checked>
                        <label class="form-check-label" for="merge_name">Merge Name (Surname + initials)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="exportType">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmExport()">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Out Modal -->
    <div class="modal fade" id="outModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Staff as Out</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="outStaffId">
                    <div class="mb-3">
                        <label class="form-label">Reason / Mode</label>
                        <select class="form-select" id="outReason">
                            <option value="Posted Out">Posted Out</option>
                            <option value="Retired">Retired</option>
                            <option value="Deceased">Deceased</option>
                            <option value="Dismissed">Dismissed</option>
                            <option value="Resigned">Resigned</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Effective Date</label>
                        <input type="text" class="form-control date-picker" id="outDate" placeholder="dd/mm/yyyy">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmOut()">Confirm Exit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Exit Modal -->
    <div class="modal fade" id="reviewExitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Review Exit Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reviewStaffId">
                    <p>An office admin has requested to exit this personnel.</p>
                    <div class="alert alert-info" id="reviewExitDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="processExitRequest('reject')">Reject</button>
                    <button type="button" class="btn btn-success" onclick="processExitRequest('approve')">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Move Modal -->
    <div class="modal fade" id="moveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Move Personnel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="moveStaffId">
                    <div class="mb-3">
                        <label class="form-label">Select New Office</label>
                        <select class="form-select" id="moveOfficeSelect" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Effective Date</label>
                        <input type="text" class="form-control date-picker" id="moveDate" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea class="form-control" id="moveRemarks" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitMove()">Move</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Request Details</h5>
                    <button type="button" class="btn-close" onclick="editRequestModalInstance.hide()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editRequestModalId">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>NIS/No:</strong> <span id="editReqStaffNis"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Name:</strong> <span id="editReqStaffName"></span>
                            </div>
                            <div class="col-md-4">
                                <strong>Requested At:</strong> <span id="editReqCreatedAt"></span>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Old Value</th>
                                    <th>New Value</th>
                                </tr>
                            </thead>
                            <tbody id="editReqChangesBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="editRequestModalInstance.hide()">Close</button>
                    <button type="button" class="btn btn-danger" onclick="rejectEditRequestFromModal()">Reject</button>
                    <button type="button" class="btn btn-success" onclick="approveEditRequestFromModal()">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Posting History</h5>
                    <button type="button" class="btn-close" onclick="historyModalInstance.hide()"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="historyModalInstance.hide()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Staff Modal (Read Only) -->
    <div class="modal fade" id="viewStaffModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Personnel Details</h5>
                    <button type="button" class="btn-close" onclick="viewModalInstance.hide()"></button>
                </div>
                <div class="modal-body" id="viewStaffBody">
                    <!-- Content will be populated via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="viewModalInstance.hide()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label required">Old Password</label>
                            <input type="password" class="form-control" id="cpOldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">New Password</label>
                            <input type="password" class="form-control" id="cpNewPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Confirm New Password</label>
                            <input type="password" class="form-control" id="cpConfirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            try {
                var token = localStorage.getItem('token');
                if (!token || token === 'null' || token === 'undefined') {
                    localStorage.clear();
                    if (window.location.pathname !== '/login.html') {
                        window.location.replace('/login.html');
                    }
                }
            } catch (e) {}
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Global Fetch Interceptor for 401 handling
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const [resource, config] = args;
            const response = await originalFetch(resource, config);
            
            if (response.status === 401) {
                const url = typeof resource === 'string' ? resource : resource.url;
                // Determine if request is to our backend (relative or same origin)
                const isAbsolute = url.startsWith('http://') || url.startsWith('https://');
                const isMyHost = isAbsolute ? url.includes(window.location.host) : true;
                
                if (isMyHost) {
                    console.warn('Session expired (401). Redirecting to login...');
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
            }
            return response;
        };

        // API Base URL
        const API_URL = ""; 

        // State Management
        let allStates = [];
        let officesList = [];
        let outModal;
        let leaveModal;
        let exportModal;
        let changePasswordModal;
        let currentStatusFilter = 'completed'; // Default to completed
        let currentStatus = 'active'; // 'active' or 'exited'
        let userId = localStorage.getItem('userId');
        let currentOfficeName = '';
        let rankSummaryChart;
        let officeSummaryChart;
        const RANKS = [
            "DCG", "ACG", "CIS", "DCI", "ACI", "CSI", "SI", "DSI",
            "ASI 1", "ASI 2", "II", "AII", "IA 1", "IA 2", "IA 3"
        ];
        
        // DOM Elements - Sidebar removed
        
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username');
        const token = localStorage.getItem('token');

        if (!token || token === 'null' || token === 'undefined') {
            localStorage.clear();
            window.location.href = '/login.html';
        } else {
            originalFetch(`${API_URL}/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(res => {
                if (!res.ok) {
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
            }).catch(() => {
                localStorage.clear();
                window.location.href = '/login.html';
            });
        }

        document.getElementById('userDisplayNavbar').textContent = `${role === 'staff' ? 'Staff' : 'Admin'}: ${username || ''}`;

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // View Navigation
        function showView(viewId) {
            if (viewId === 'offices' && role === 'office_admin') {
                alert('Permission denied');
                return;
            }
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
            // Show target view
            document.getElementById(`view-${viewId}`).classList.remove('d-none');
            
            // Update Title
            const titles = {
                'dashboard': 'Dashboard',
                'personnel': 'Personnel Management',
                'offices': 'Offices Directory',
                'leave': 'Leave Management',
                'audit': 'Audit Logs',
                'approvals': 'Change Authorizations',
                'success': 'Action Successful'
            };
            document.getElementById('pageTitle').textContent = titles[viewId] || 'V/R';

            // Trigger loads
            if(viewId === 'dashboard') loadDashboardStats();
            if(viewId === 'offices') loadOfficesView();
            if(viewId === 'audit') loadAuditLogs();
            if(viewId === 'approvals') loadApprovalsView();
            if(viewId === 'leave') loadLeaveRequests();
            if(viewId === 'personnel') {
                // If coming to personnel, maybe refresh list?
                // loadStaff(); // Optional
            }
        }

        function showPersonnelTab(tabId) {
            showView('personnel');
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
            }
        }

        function showPrivileges() {
            if (role !== 'super_admin') return;
            showPersonnelTab('privileges-tab');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log("DOM Loaded, starting initialization...");
                
                // 1. Init Form Listener (Highest Priority)
                const staffForm = document.getElementById('staffForm');
                if (staffForm) {
                    // Ensure no duplicates and force handleFormSubmit
                    staffForm.removeEventListener('submit', handleFormSubmit);
                    staffForm.addEventListener('submit', handleFormSubmit);
                }
                
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            loadStaff();
                        }
                    });
                }

                // Auto-uppercase Surname and Other Names
                ['surname', 'other_names'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', function() {
                            this.value = this.value.toUpperCase();
                        });
                        el.addEventListener('blur', function() {
                            this.value = this.value.toUpperCase();
                        });
                    }
                });

                // Init Common Data
                populateRanks();
                await fetchStates();
                await loadOffices(); // For dropdown

                // Init Modals
                const outEl = document.getElementById('outModal');
                if (outEl) outModal = new bootstrap.Modal(outEl);
                
                const expEl = document.getElementById('exportModal');
                if (expEl) exportModal = new bootstrap.Modal(expEl);
                
                const reviewEl = document.getElementById('reviewExitModal');
                if (reviewEl) reviewExitModal = new bootstrap.Modal(reviewEl);

                const cpEl = document.getElementById('changePasswordModal');
                if (cpEl) changePasswordModal = new bootstrap.Modal(cpEl);
                
                // historyModal, moveModal, viewStaffModal are initialized in global DOMContentLoaded below
                
                // Init DatePickers
                flatpickr(".date-picker", {
                    dateFormat: "d/m/Y",
                    allowInput: true
                });

                // Listen for tab changes to load specific data
                const privilegesTab = document.getElementById('privileges-tab');
                if(privilegesTab) {
                    privilegesTab.addEventListener('shown.bs.tab', loadPrivileges);
                }
                
                const resetTab = document.getElementById('password-reset-tab');
                if(resetTab) {
                    resetTab.addEventListener('shown.bs.tab', loadResetList);
                }

                // Role Based UI
                    if (role === 'staff') {
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('d-none'));
                        
                        // Customize Dashboard for Staff
                        const dashView = document.getElementById('view-dashboard');
                        if (dashView) {
                            dashView.innerHTML = `
                                <div class="row justify-content-center mt-5">
                                    <div class="col-md-6 text-center">
                                        <div class="card shadow">
                                            <div class="card-body p-5">
                                                <h3 class="card-title mb-4">Welcome, ${localStorage.getItem('username') || 'Staff'}</h3>
                                                <p class="mb-1"><strong>Current Office:</strong> <span id="staffDashboardOffice">Loading...</span></p>
                                                <p class="mb-3"><strong>DOPP:</strong> <span id="staffDashboardDopp">Loading...</span></p>
                                                <div id="staffMoveNotification" class="alert alert-info d-none mb-4"></div>
                                                <div class="d-grid gap-3">
                                                    <button class="btn btn-primary btn-lg" onclick="openChangePasswordModal()">
                                                        <i class="bi bi-key me-2"></i>Change Password
                                                    </button>
                                                    <button class="btn btn-danger btn-lg" onclick="logout()">
                                                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            await loadStaffDashboardInfo();
                        }

                    // Show form view directly
                    showView('personnel');
                    
                    // Show form tab
                    const formTabBtn = document.getElementById('form-tab');
                    formTabBtn.classList.remove('d-none');
                    const formTab = new bootstrap.Tab(formTabBtn);
                    formTab.show();
                    
                    // Hide list tab navigation and cancel button
                    const listTabBtn = document.getElementById('list-tab');
                    if(listTabBtn) listTabBtn.parentElement.classList.add('d-none');
                    const cancelBtn = document.querySelector('#staffForm button[onclick="showList()"]');
                    if(cancelBtn) cancelBtn.classList.add('d-none');
                    
                    // Hide Personnel and Leave from Navbar
                    const navPersonnel = document.getElementById('nav-personnel');
                    if (navPersonnel) navPersonnel.classList.add('d-none');
                    
                    const navLeave = document.getElementById('nav-leave');
                    if (navLeave) navLeave.classList.add('d-none');
                    
                    // Load own data if userId exists
                    if(userId) {
                        console.log("Found userId:", userId, "- triggering editStaff");
                        await editStaff(userId);
                    } else {
                        console.error("No userId found in localStorage for staff user");
                        alert("Error: User ID missing. Please logout and login again.");
                    }
                    
                    return;
                } else if (role === 'office_admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('d-none'));
                    await fetchUserOffice();
                } else if (role === 'main_admin') {
                    const importTab = document.getElementById('import-tab')?.parentElement;
                    if (importTab) importTab.classList.add('d-none');
                    document.querySelectorAll('.super-only').forEach(el => el.classList.add('d-none'));
                }

                if (role === 'super_admin' || role === 'main_admin') {
                    await fetchApprovalCounts();
                }

                loadStaff();

                const params = new URLSearchParams(window.location.search);
                const officeChart = params.get('officeChart');
                const officeName = params.get('office');

                if (officeChart === '1' && officeName) {
                    showView('offices');
                    await loadOfficesView();
                    await showOfficeSummary(officeName);
                } else {
                    showView('dashboard');
                }

            } catch (err) {
                console.error("Initialization Error:", err);
                alert("Initialization Failed: " + err.message);
            } finally {
                // Hide loader
                const loader = document.getElementById('global-loader');
                if (loader) loader.style.display = 'none';
            }
        });

        function roleLabel(r) {
            if (r === 'super_admin') return 'Super Admin';
            if (r === 'office_admin') return 'Office Admin';
            if (r === 'main_admin') return 'Main Admin';
            if (r === 'staff') return 'Staff';
            return r || '';
        }

        async function loadStaffDashboardInfo() {
            if (!userId) return;
            try {
                const res = await fetch(`${API_URL}/staff/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const s = await res.json();
                const office = s.office || 'Not assigned';
                const doppStr = isoToDmy(s.dopp);
                const officeEl = document.getElementById('staffDashboardOffice');
                const doppEl = document.getElementById('staffDashboardDopp');
                if (officeEl) officeEl.textContent = office;
                if (doppEl) doppEl.textContent = doppStr || '-';

                const lastOfficeKey = `staff_${userId}_last_office`;
                const lastDoppKey = `staff_${userId}_last_dopp`;
                const prevOffice = localStorage.getItem(lastOfficeKey);
                const prevDopp = localStorage.getItem(lastDoppKey);

                if (prevOffice && prevOffice !== office) {
                    const notifEl = document.getElementById('staffMoveNotification');
                    if (notifEl) {
                        notifEl.classList.remove('d-none');
                        notifEl.textContent = `You have been moved from ${prevOffice} to ${office}. Effective date: ${doppStr || 'N/A'}.`;
                    }
                }

                localStorage.setItem(lastOfficeKey, office);
                localStorage.setItem(lastDoppKey, s.dopp || '');
            } catch (e) {
                console.error('Failed to load staff dashboard info', e);
            }
        }

        function rankBadge(rank) {
            const text = rank || '';
            if (!text) return '';
            
            // Define groups
            const red = ['DCG'];
            const green = ['ACG', 'CIS', 'DCI', 'ACI'];
            const blue = ['CSI', 'SI', 'DSI', 'ASI1', 'ASI 1', 'ASI2', 'ASI 2'];
            const yellow = ['II', 'AII', 'IA1', 'IA 1', 'IA2', 'IA 2', 'IA3', 'IA 3'];
            
            let color = 'bg-secondary'; // Default
            if (red.includes(text)) color = 'bg-danger';
            else if (green.includes(text)) color = 'bg-success';
            else if (blue.includes(text)) color = 'bg-primary';
            else if (yellow.includes(text)) color = 'bg-warning text-dark';
            
            return `<span class="badge ${color} rounded-pill">${text}</span>`;
        }

        // Dashboard Logic
        async function fetchUserOffice() {
            if (role !== 'office_admin') return;
            try {
                const res = await fetch(`${API_URL}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    currentOfficeName = data.office_name;
                }
            } catch(e) { console.error("Failed to fetch office info", e); }
        }

        async function loadDashboardStats() {
            try {
                const res = await fetch(`${API_URL}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    const card1Title = document.getElementById('dash-card1-title');
                    const card2Title = document.getElementById('dash-card2-title');
                    const card2Text = document.getElementById('dash-card2-text');

                    if (role === 'office_admin') {
                        const officeName = data.office_name || 'Your Office';
                        if (card1Title) card1Title.textContent = `Total Personnel (${officeName})`;
                        if (card2Title) card2Title.textContent = 'Office Name';
                        if (card2Text) card2Text.textContent = 'Your assigned office';

                        document.getElementById('dash-total-staff').textContent = data.total_staff ?? 0;
                        document.getElementById('dash-total-offices').textContent = data.office_name || '';
                    } else {
                        if (card1Title) card1Title.textContent = 'Total Personnel';
                        if (card2Title) card2Title.textContent = 'Total Offices';
                        if (card2Text) card2Text.textContent = 'Click to view offices';

                        document.getElementById('dash-total-staff').textContent = data.total_staff ?? 0;
                        document.getElementById('dash-total-offices').textContent = data.total_offices ?? 0;
                    }

                    const rankCounts = data.rank_counts || {};
                    const groupCounts = {
                        "Comptroller Cadre": 0,
                        "Superintendent Cadre": 0,
                        "Inspectorate Cadre": 0,
                        "Assistant Cadre": 0
                    };
                    Object.entries(rankCounts).forEach(([rank, count]) => {
                        const r = String(rank || "").toUpperCase();
                        const normalized = r.replace(/[\s\-]/g, "");
                        let group = null;
                        if (["DCG","ACG","CIS","DCI","ACI"].includes(normalized)) {
                            group = "Comptroller Cadre";
                        } else if (["CSI","SI","DSI","ASI1","ASI2"].includes(normalized)) {
                            group = "Superintendent Cadre";
                        } else if (["II","AII"].includes(normalized)) {
                            group = "Inspectorate Cadre";
                        } else if (["IA1","IA2","IA3"].includes(normalized)) {
                            group = "Assistant Cadre";
                        }
                        if (group) {
                            groupCounts[group] += count || 0;
                        }
                    });

                    const ctx = document.getElementById('rankSummaryChart');
                    if (ctx) {
                        const labels = Object.keys(groupCounts);
                        const values = labels.map(l => groupCounts[l]);
                        const colors = [
                            'rgba(220,53,69,0.85)',
                            'rgba(25,135,84,0.85)',
                            'rgba(13,110,253,0.85)',
                            'rgba(255,193,7,0.85)'
                        ];
                        const borderColors = [
                            'rgba(220,53,69,1)',
                            'rgba(25,135,84,1)',
                            'rgba(13,110,253,1)',
                            'rgba(255,193,7,1)'
                        ];
                        if (rankSummaryChart) {
                            rankSummaryChart.data.labels = labels;
                            rankSummaryChart.data.datasets[0].data = values;
                            rankSummaryChart.update();
                        } else {
                            rankSummaryChart = new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: values,
                                        backgroundColor: colors,
                                        borderColor: borderColors,
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: {
                                            position: 'bottom'
                                        }
                                    }
                                }
                            });
                        }
                    }
                }
            } catch(e) { console.error(e); }
        }

        // Offices View Logic
        let officeModal; 

        document.addEventListener('DOMContentLoaded', () => {
             // ... (existing listeners)
             const officeEl = document.getElementById('officeModal');
             if (officeEl) officeModal = new bootstrap.Modal(officeEl);
        });

        async function loadOfficesView() {
            try {
                const res = await fetch(`${API_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const offices = await res.json();
                    const tbody = document.getElementById('officesTableBody');
                    tbody.innerHTML = '';
                    offices.forEach(off => {
                        const tr = document.createElement('tr');
                        const safeName = String(off.name || '').replace(/'/g, "\\'");
                        const urlName = encodeURIComponent(off.name || '');
                        tr.innerHTML = `
                            <td class="text-primary" style="cursor:pointer;" onclick="openOfficeChartPage('${urlName}')">${off.name}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editOffice(${off.id}, '${safeName}')">Rename</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOffice(${off.id})">Remove</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    if (offices.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="2" class="text-muted text-center">No offices found</td>`;
                        tbody.appendChild(tr);
                    }
                } else {
                    const tbody = document.getElementById('officesTableBody');
                    const data = await res.json().catch(() => ({}));
                    tbody.innerHTML = `<tr><td colspan="2" class="text-danger text-center">${data.detail || 'Failed to load offices'}</td></tr>`;
                }
            } catch(e) { console.error(e); }
        }

        function openOfficeChartPage(encodedName) {
            const url = new URL(window.location.href);
            url.searchParams.set('officeChart', '1');
            url.searchParams.set('office', decodeURIComponent(encodedName));
            window.location.href = url.toString();
        }

        function openOfficeModal() {
            document.getElementById('officeId').value = '';
            document.getElementById('officeName').value = '';
            document.getElementById('officeModalTitle').textContent = 'Add Office';
            officeModal.show();
        }

        function editOffice(id, name) {
            document.getElementById('officeId').value = id;
            document.getElementById('officeName').value = name;
            document.getElementById('officeModalTitle').textContent = 'Rename Office';
            officeModal.show();
        }

        async function saveOffice() {
            const id = document.getElementById('officeId').value;
            const name = document.getElementById('officeName').value;
            if(!name) return alert("Name is required");

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/offices/${id}` : `${API_URL}/offices`;
            
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });
                if(res.ok) {
                    officeModal.hide();
                    loadOfficesView();
                    loadOffices(); // Refresh dropdowns
                    loadDashboardStats(); // Refresh stats
                } else {
                    const data = await res.json().catch(() => ({}));
                    alert("Failed to save office: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        async function deleteOffice(id) {
            if(!confirm("Are you sure? This will remove the office from the system.")) return;
            try {
                const res = await fetch(`${API_URL}/offices/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    loadOfficesView();
                    loadOffices();
                    loadDashboardStats();
                } else {
                    alert("Failed to delete office");
                }
            } catch(e) { console.error(e); }
        }

        // --- EXISTING FUNCTIONS ADAPTED ---

        function pad2(n) { return String(n).padStart(2, '0'); }
        function isoToDmy(value) {
            if (!value) return '';
            let s = String(value);
            // Handle ISO strings with time (e.g. 2023-01-01T00:00:00)
            if (s.includes('T')) s = s.split('T')[0];
            
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!m) return value; 
            return `${m[3]}/${m[2]}/${m[1]}`; 
        }
        function userDateToIsoOrNull(val) {
            if(!val) return null;
            val = String(val).trim();
            // If already YYYY-MM-DD (or similar ISO start), return it
            if (/^\d{4}-\d{2}-\d{2}/.test(val)) return val.substring(0, 10);
            
            const parts = val.split('/');
            if(parts.length === 3) {
                const d = parts[0].padStart(2, '0');
                const m = parts[1].padStart(2, '0');
                const y = parts[2];
                return `${y}-${m}-${d}`;
            }
            return null;
        }

        async function fetchStates() {
            try {
                const res = await fetch(`${API_URL}/states`);
                allStates = await res.json();
                const sel = document.getElementById('state_id');
                sel.innerHTML = '<option value="">Select State...</option>';
                allStates.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    sel.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }

        async function loadLGAs(stateId) {
            const lgaSel = document.getElementById('lga_id');
            lgaSel.innerHTML = '<option value="">Select LGA...</option>';
            lgaSel.disabled = true;
            if (!stateId) return;
            
            try {
                const res = await fetch(`${API_URL}/states/${stateId}/lgas`);
                if (res.ok) {
                    const lgas = await res.json();
                    lgas.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        lgaSel.appendChild(opt);
                    });
                    lgaSel.disabled = false;
                }
            } catch(e) { console.error(e); }
        }

        function filterDropdown(input) {
            const filter = input.value.toLowerCase();
            const container = input.closest('ul').querySelector('div[id$="Container"]');
            const items = container.querySelectorAll('.form-check');
            items.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        }

        function updateFilterLabel(type) {
            const checkboxes = document.querySelectorAll(`.filter-${type.toLowerCase()}-cb:checked`);
            const btn = document.getElementById(`filter${type}Btn`);
            if(checkboxes.length === 0) {
                btn.textContent = `All ${type}s`;
            } else if(checkboxes.length === 1) {
                btn.textContent = checkboxes[0].value;
            } else {
                btn.textContent = `${checkboxes.length} selected`;
            }
        }

        function populateRanks() {
            // Populate Form Select (Single)
            const sel = document.getElementById('rank');
            if(sel) {
                sel.innerHTML = '<option value="">Select...</option>';
                RANKS.forEach(r => {
                    sel.add(new Option(r, r));
                });
            }
            
            // Populate Filter Dropdown (Multi)
            const container = document.getElementById('filterRankContainer');
            if(container) {
                container.innerHTML = '';
                RANKS.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input filter-rank-cb" type="checkbox" value="${r}" id="fr_${r.replace(/\s/g, '')}" onchange="updateFilterLabel('Rank'); loadStaff();">
                        <label class="form-check-label" for="fr_${r.replace(/\s/g, '')}">${r}</label>
                    `;
                    container.appendChild(div);
                });
            }
        }

        async function loadOffices() {
            // Populate Dropdown for filters and form
            // Reuse /offices endpoint
            try {
                const res = await fetch(`${API_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const offices = await res.json();
                    const formSel = document.getElementById('office');
                    const filterContainer = document.getElementById('filterOfficeContainer');
                    
                    if(formSel) formSel.innerHTML = '<option value="">Select...</option>';
                    if(filterContainer) filterContainer.innerHTML = '';
                    
                    officesList = offices.map(o => o.name);
                    officesList.forEach((name, idx) => {
                         if(formSel) formSel.add(new Option(name, name));
                         
                         if(filterContainer) {
                             const div = document.createElement('div');
                             div.className = 'form-check';
                             div.innerHTML = `
                                <input class="form-check-input filter-office-cb" type="checkbox" value="${name}" id="fo_${idx}" onchange="updateFilterLabel('Office'); loadStaff();">
                                <label class="form-check-label" for="fo_${idx}">${name}</label>
                             `;
                             filterContainer.appendChild(div);
                         }
                    });
                }
            } catch(e) { console.error(e); }
        }


        async function loadResetList() {
            const q = document.getElementById('resetSearchInput').value;
            let url = `${API_URL}/staff?limit=50`; // Default to active staff
            if (q) url += `&q=${encodeURIComponent(q)}`;
            
            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) throw new Error("Failed");
                const data = await res.json();
                renderResetTable(data);
            } catch (err) { console.error(err); }
        }

        function renderResetTable(data) {
             const tbody = document.getElementById('resetTableBody');
             tbody.innerHTML = '';
             data.forEach(s => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                     <td>${s.nis_no}</td>
                     <td>${s.surname} ${s.other_names}</td>
                     <td>${s.rank}</td>
                     <td>${s.office || ''}</td>
                     <td>
                         <button class="btn btn-sm btn-secondary me-1" onclick="resetUserPassword(${s.id})">Reset Pwd</button>
                         <button class="btn btn-sm btn-warning" onclick="resetUserLogin(${s.id})">Reset Login</button>
                     </td>
                 `;
                 tbody.appendChild(tr);
             });
        }

        async function loadStaff() {
            const q = document.getElementById('searchInput').value;
            const doppOrder = document.getElementById('sortDopp').value;
            
            const params = new URLSearchParams();
            params.append('limit', '100');
            if (q) params.append('q', q);
            if (doppOrder) params.append('dopp_order', doppOrder);
            if (currentStatus === 'exited') {
                const exitFrom = document.getElementById('exitFrom');
                const exitTo = document.getElementById('exitTo');
                const fromVal = exitFrom ? exitFrom.value : '';
                const toVal = exitTo ? exitTo.value : '';
                if (fromVal) params.append('exit_from', userDateToIsoOrNull(fromVal));
                if (toVal) params.append('exit_to', userDateToIsoOrNull(toVal));
            }
             // If searching, include both Completed and Incomplete by omitting completeness filter
             if (!q && currentStatusFilter) params.append('completeness', currentStatusFilter);
             if (currentStatus) params.append('status', currentStatus);
             
             // Multi-select Ranks
             document.querySelectorAll('.filter-rank-cb:checked').forEach(cb => params.append('rank', cb.value));
             
            // Multi-select Offices
            document.querySelectorAll('.filter-office-cb:checked').forEach(cb => params.append('office', cb.value));
            
            try {
                const res = await fetch(`${API_URL}/staff?${params.toString()}`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) {
                     const errText = await res.text();
                     throw new Error(`Failed to load staff: ${res.status} ${errText}`);
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error("Invalid data format received");
                if (role === 'super_admin' || role === 'main_admin') {
                    buildSuperAdminTableHeader();
                    renderTableSuperAdmin(data);
                } else {
                    buildStandardTableHeader();
                    renderTable(data);
                }
            } catch (err) { 
                console.error(err); 
                document.getElementById('staffTableBody').innerHTML = `<tr><td colspan="9" class="text-danger text-center">Error loading data: ${err.message}</td></tr>`;
            }
        }

        function setMainStatus(status, el) {
            currentStatus = status;
            document.querySelectorAll('#mainStatusTabs .nav-link').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            const exitedOnlyEls = document.querySelectorAll('.exited-only');
            exitedOnlyEls.forEach(col => {
                if (status === 'exited') {
                    col.classList.remove('d-none');
                } else {
                    col.classList.add('d-none');
                }
            });
            const sortSel = document.getElementById('sortDopp');
            if (sortSel) {
                const defOpt = sortSel.querySelector('option[value=""]');
                const ascOpt = sortSel.querySelector('option[value="asc"]');
                const descOpt = sortSel.querySelector('option[value="desc"]');
                if (status === 'exited') {
                    if (defOpt) defOpt.textContent = 'Sort by Effective Date';
                    if (ascOpt) ascOpt.textContent = 'Effective Date Ascending';
                    if (descOpt) descOpt.textContent = 'Effective Date Descending';
                } else {
                    if (defOpt) defOpt.textContent = 'Sort by DOPP';
                    if (ascOpt) ascOpt.textContent = 'DOPP Ascending';
                    if (descOpt) descOpt.textContent = 'DOPP Descending';
                }
            }
            loadStaff();
        }
        
        function setStatusFilter(status, el) {
            currentStatusFilter = status;
            document.querySelectorAll('#statusTabs .nav-link').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            loadStaff();
        }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            
            // Reset Dropdowns
            document.querySelectorAll('.filter-rank-cb').forEach(cb => cb.checked = false);
            updateFilterLabel('Rank');
            document.querySelectorAll('.filter-office-cb').forEach(cb => cb.checked = false);
            updateFilterLabel('Office');
            
            document.getElementById('sortDopp').value = '';
            const exitFrom = document.getElementById('exitFrom');
            const exitTo = document.getElementById('exitTo');
            if (exitFrom) exitFrom.value = '';
            if (exitTo) exitTo.value = '';
            
            currentStatus = 'active';
            currentStatusFilter = 'completed';
            
            // Reset tab UI states
            const mainTabs = document.querySelectorAll('#mainStatusTabs .nav-link');
            if (mainTabs.length >= 2) {
                mainTabs.forEach(a => a.classList.remove('active'));
                mainTabs[0].classList.add('active'); // Active Personnel
            }
            const statusTabs = document.querySelectorAll('#statusTabs .nav-link');
            if (statusTabs.length >= 2) {
                statusTabs.forEach(a => a.classList.remove('active'));
                statusTabs[0].classList.add('active'); // Completed
            }
            
            loadStaff();
        }

        function buildSuperAdminTableHeader() {
            const thead = document.getElementById('staffTableHead');
            if (!thead) return;
            let html;
            if (currentStatus === 'exited') {
                html = `
                    <tr>
                        <th>S/N</th>
                        <th>NIS/No</th>
                        <th>Surname</th>
                        <th>Other Names</th>
                        <th>Rank</th>
                        <th>Phone No</th>
                        <th>Reason for Exit</th>
                        <th>Effective Date</th>
                        <th>Actions</th>
                    </tr>
                `;
            } else {
                html = `
                    <tr>
                        <th>S/N</th>
                        <th>NIS/No</th>
                        <th>Surname</th>
                        <th>Other Names</th>
                        <th>Rank</th>
                        <th>Gender</th>
                        <th>DOB</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Qual</th>
                        <th>Office</th>
                        <th>State</th>
                        <th>LGA</th>
                        <th>DOFA</th>
                        <th>DOPA</th>
                        <th>DOPP</th>
                        <th>Home Town</th>
                        <th>Next of Kin</th>
                        <th>NOK Phone</th>
                        <th>Remark</th>
                        <th>Actions</th>
                    </tr>
                `;
            }
            thead.innerHTML = html;
        }

        function buildStandardTableHeader() {
            const thead = document.getElementById('staffTableHead');
            if (!thead) return;
            let html;
            if (currentStatus === 'exited') {
                html = `
                    <tr>
                        <th>S/N</th>
                        <th>NIS/No</th>
                        <th>Surname</th>
                        <th>Other Names</th>
                        <th>Rank</th>
                        <th>Phone No</th>
                        <th>Reason for Exit</th>
                        <th>Effective Date</th>
                        <th>Actions</th>
                    </tr>
                `;
            } else {
                html = `
                    <tr>
                        <th>S/N</th>
                        <th>NIS/No</th>
                        <th>Name</th>
                        <th>Rank</th>
                        <th>DOFA / DOPA</th>
                        <th>Office</th>
                        <th>State/LGA</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                `;
            }
            thead.innerHTML = html;
        }

        function renderTableSuperAdmin(data) {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';
            data.forEach((s, index) => {
                const tr = document.createElement('tr');
                tr.dataset.staffId = s.id;
                const sName = s.state ? s.state.name : '';
                const lName = s.lga ? s.lga.name : '';
                const dofa = isoToDmy(s.dofa);
                const dopa = isoToDmy(s.dopa);
                const dopp = isoToDmy(s.dopp);
                const dob = isoToDmy(s.dob);
                const rankOpts = RANKS.map(r => `<option value="${r}" ${s.rank===r?'selected':''}>${r}</option>`).join('');
                const genderOpts = ['Male','Female'].map(g => `<option value="${g}" ${s.gender===g?'selected':''}>${g}</option>`).join('');
                const officeOpts = officesList.map(o => `<option value="${o}" ${s.office===o?'selected':''}>${o}</option>`).join('');
                const stateOpts = allStates.map(st => `<option value="${st.id}" ${s.state && s.state.id===st.id?'selected':''}>${st.name}</option>`).join('');
                let actionBtns = ``;
                if (currentStatus === 'exited') {
                    actionBtns += `<button class="btn btn-sm btn-info mb-1" onclick="undoExit(${s.id})">Undo Exit</button>`;
                    actionBtns += `<button class="btn btn-sm btn-secondary mb-1" onclick="openHistoryModal(${s.id})">History</button>`;
                    actionBtns += `<button class="btn btn-sm btn-info mb-1" onclick="openViewModal(${s.id})">View</button>`;
                } else {
                    actionBtns += `<button class="btn btn-sm btn-primary mb-1" onclick="editStaff(${s.id})">Edit</button>`;
                    actionBtns += `<button class="btn btn-sm btn-danger mb-1" onclick="deleteStaff(${s.id})">Del</button>`;
                    actionBtns += `<button class="btn btn-sm btn-dark mb-1" onclick="openMoveModal(${s.id})">Move</button>`;
                    actionBtns += `<button class="btn btn-sm btn-secondary mb-1" onclick="openHistoryModal(${s.id})">History</button>`;
                    if (s.out_request_status === 'Pending') {
                        actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openReviewExitModal(${s.id}, '${s.out_request_date}', '${s.out_request_reason}')">Review Exit</button>`;
                    } else {
                        actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openOutModal(${s.id})">Out</button>`;
                    }
                }
                if (currentStatus === 'exited') {
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td contenteditable="true" data-field="nis_no" data-original="${s.nis_no || ''}">${s.nis_no || ''}</td>
                        <td contenteditable="true" data-field="surname" data-original="${s.surname || ''}">${s.surname || ''}</td>
                        <td contenteditable="true" data-field="other_names" data-original="${s.other_names || ''}">${s.other_names || ''}</td>
                        <td data-rank-cell>
                            <span class="rank-badge">${rankBadge(s.rank)}</span>
                            <select class="form-select form-select-sm d-none" data-select-field="rank" data-original="${s.rank || ''}">${rankOpts}</select>
                            <button type="button" class="btn btn-sm btn-outline-info ms-1" title="Edit rank" data-rank-toggle>
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                        <td contenteditable="true" data-field="phone_no" data-original="${s.phone_no || ''}">${s.phone_no || ''}</td>
                        <td>${s.exit_mode || ''}</td>
                        <td>${isoToDmy(s.exit_date) || ''}</td>
                        <td>${actionBtns}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td contenteditable="true" data-field="nis_no" data-original="${s.nis_no || ''}">${s.nis_no || ''}</td>
                        <td contenteditable="true" data-field="surname" data-original="${s.surname || ''}">${s.surname || ''}</td>
                        <td contenteditable="true" data-field="other_names" data-original="${s.other_names || ''}">${s.other_names || ''}</td>
                        <td data-rank-cell>
                            <span class="rank-badge">${rankBadge(s.rank)}</span>
                            <select class="form-select form-select-sm d-none" data-select-field="rank" data-original="${s.rank || ''}">${rankOpts}</select>
                            <button type="button" class="btn btn-sm btn-outline-info ms-1" title="Edit rank" data-rank-toggle>
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                        <td><select class="form-select form-select-sm" data-select-field="gender" data-original="${s.gender || ''}">${genderOpts}</select></td>
                        <td contenteditable="true" data-field="dob" data-original="${dob || ''}">${dob || ''}</td>
                        <td contenteditable="true" data-field="phone_no" data-original="${s.phone_no || ''}">${s.phone_no || ''}</td>
                        <td contenteditable="true" data-field="email" data-original="${s.email || ''}">${s.email || ''}</td>
                        <td contenteditable="true" data-field="qualification" data-original="${s.qualification || ''}">${s.qualification || ''}</td>
                        <td><select class="form-select form-select-sm" data-select-field="office" data-original="${s.office || ''}">${officeOpts}</select></td>
                        <td>
                            <select class="form-select form-select-sm" data-select-field="state_id" data-original="${s.state ? s.state.id : ''}">
                                <option value="">Select...</option>
                                ${stateOpts}
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" data-select-field="lga_id" data-original="${s.lga ? s.lga.id : ''}">
                                <option value="">${s.state ? 'Select LGA...' : 'Select State First'}</option>
                            </select>
                        </td>
                        <td contenteditable="true" data-field="dofa" data-original="${dofa || ''}">${dofa || ''}</td>
                        <td contenteditable="true" data-field="dopa" data-original="${dopa || ''}">${dopa || ''}</td>
                        <td contenteditable="true" data-field="dopp" data-original="${dopp || ''}">${dopp || ''}</td>
                        <td contenteditable="true" data-field="home_town" data-original="${s.home_town || ''}">${s.home_town || ''}</td>
                        <td contenteditable="true" data-field="next_of_kin" data-original="${s.next_of_kin || ''}">${s.next_of_kin || ''}</td>
                        <td contenteditable="true" data-field="nok_phone" data-original="${s.nok_phone || ''}">${s.nok_phone || ''}</td>
                        <td contenteditable="true" data-field="remark" data-original="${s.remark || ''}">${s.remark || ''}</td>
                        <td>${actionBtns}</td>
                    `;
                }
                tbody.appendChild(tr);
                
                // Populate LGA select per row if state present
                const lgaSel = tr.querySelector('select[data-select-field="lga_id"]');
                const stateSel = tr.querySelector('select[data-select-field="state_id"]');
                if (stateSel && lgaSel && stateSel.value) {
                    loadLGAsForRow(stateSel.value, lgaSel, s.lga ? s.lga.id : null);
                }
            });
        }

        async function updateStaffField(id, field, value, el) {
            try {
                // Ensure numeric id values are numbers
                if (field.endsWith('_id') && typeof value === 'string' && value) {
                    value = parseInt(value, 10);
                }
                const res = await fetch(`${API_URL}/staff/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ [field]: value })
                });
                if (!res.ok) {
                    let msg = '';
                    try { const err = await res.json(); msg = err.detail || ''; } catch(e) {}
                    alert(`Update failed: ${msg || res.status}`);
                    if (el && el.tagName === 'SELECT') {
                        el.value = el.dataset.original || '';
                    } else if (el) {
                        el.textContent = el.dataset.original || '';
                    }
                    return;
                }
                if (res.status === 202) {
                    alert('Update submitted for approval and will apply after review.');
                    if (el && el.tagName === 'SELECT') {
                        el.value = el.dataset.original || '';
                    } else if (el) {
                        el.textContent = el.dataset.original || '';
                    }
                    return;
                }
                if (el && el.tagName === 'SELECT') {
                    el.dataset.original = el.value;
                } else if (el) {
                    el.dataset.original = el.textContent.trim();
                }
            } catch (e) {
                alert(`Network error: ${e.message}`);
                if (el && el.tagName === 'SELECT') {
                    el.value = el.dataset.original || '';
                } else if (el) {
                    el.textContent = el.dataset.original || '';
                }
            }
        }

        document.getElementById('staffTableBody').addEventListener('blur', function(e) {
            const td = e.target.closest('td[contenteditable="true"]');
            if (!td) return;
            const tr = td.closest('tr');
            const id = tr.dataset.staffId;
            const field = td.dataset.field;
            const newVal = td.textContent.trim();
            const oldVal = td.dataset.original || '';
            if (newVal === oldVal) return;
            updateStaffField(id, field, newVal, td);
        }, true);

        document.getElementById('staffTableBody').addEventListener('change', async function(e) {
            const sel = e.target.closest('select[data-select-field]');
            if (!sel) return;
            const tr = sel.closest('tr');
            const id = tr.dataset.staffId;
            const field = sel.dataset.selectField;
            const newVal = sel.value;
            const oldVal = sel.dataset.original || '';
            if (newVal === oldVal) return;
            
            // If state changed, reload LGA options and clear lga
            if (field === 'state_id') {
                const lgaSel = tr.querySelector('select[data-select-field="lga_id"]');
                if (lgaSel) {
                    lgaSel.innerHTML = '<option value="">Select LGA...</option>';
                    lgaSel.disabled = true;
                    loadLGAsForRow(newVal, lgaSel, null).then(() => { lgaSel.disabled = false; });
                }
            }
            await updateStaffField(id, field, newVal, sel);
            if (field === 'rank') {
                // Update badge UI and toggle back to view mode
                const cell = sel.closest('td[data-rank-cell]');
                const badgeWrap = cell?.querySelector('.rank-badge');
                if (badgeWrap) {
                    badgeWrap.innerHTML = rankBadge(newVal);
                    badgeWrap.classList.remove('d-none');
                }
                sel.classList.add('d-none');
            }
        });
        
        // Toggle Rank edit (show/hide select vs badge)
        document.getElementById('staffTableBody').addEventListener('click', function(e) {
            const btn = e.target.closest('[data-rank-toggle]');
            if (!btn) return;
            const cell = btn.closest('td[data-rank-cell]');
            if (!cell) return;
            const badgeWrap = cell.querySelector('.rank-badge');
            const sel = cell.querySelector('select[data-select-field="rank"]');
            if (badgeWrap && sel) {
                const editing = sel.classList.toggle('d-none') === false; // d-none removed => editing
                if (editing) {
                    badgeWrap.classList.add('d-none');
                    sel.focus();
                } else {
                    badgeWrap.classList.remove('d-none');
                }
            }
        });
        
        async function loadLGAsForRow(stateId, targetSelect, selectedLgaId) {
            if (!stateId || !targetSelect) return;
            try {
                const res = await fetch(`${API_URL}/states/${stateId}/lgas`);
                if (res.ok) {
                    const lgas = await res.json();
                    targetSelect.innerHTML = '<option value="">Select LGA...</option>';
                    lgas.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        targetSelect.appendChild(opt);
                    });
                    if (selectedLgaId) targetSelect.value = selectedLgaId;
                }
            } catch(e) { console.error(e); }
        }

        async function undoExit(id) {
            if(!confirm("Are you sure you want to undo this exit? The staff will be active again.")) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/undo-exit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    alert("Exit undone successfully");
                    loadStaff();
                } else {
                    const data = await res.json();
                    alert("Failed: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        function renderTable(data) {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';
            data.forEach((s, index) => {
                const tr = document.createElement('tr');
                // Rank, DOPA, NIS sorting logic is handled by backend now
                
                const sName = s.state ? s.state.name : '';
                const lName = s.lga ? s.lga.name : '';
                const location = (sName && lName) ? `${sName} / ${lName}` : (sName || lName || '');
                
                const dofa = isoToDmy(s.dofa);
                const dopa = isoToDmy(s.dopa);
                // const dates = (dofa && dopa) ? `${dofa} / ${dopa}` : (dofa || dopa || '');
                const dofaStr = dofa ? `<span class="small-font">${dofa}</span>` : '';
                const dopaStr = dopa ? dopa : '';
                const separator = (dofa && dopa) ? ' / ' : '';
                const dates = `${dofaStr}${separator}${dopaStr}`;
                const exitDate = isoToDmy(s.exit_date);
                const exitReason = s.exit_mode || '';

                let rowHtml = '';

                if (currentStatus === 'exited') {
                    let statusHtml = '';
                    if (role === 'super_admin' || role === 'main_admin') {
                        statusHtml = `<button class="btn btn-sm btn-info mb-1" onclick="undoExit(${s.id})">Undo Exit</button>`;
                    } else {
                        statusHtml = `<span class="badge bg-secondary">Posted Out</span>`;
                    }
                    statusHtml += `<button class="btn btn-sm btn-info mb-1 ms-1" onclick="openViewModal(${s.id})">View</button>`;
                    if (role === 'super_admin' || role === 'main_admin') {
                         statusHtml += `<button class="btn btn-sm btn-secondary mb-1 ms-1" onclick="openHistoryModal(${s.id})">History</button>`;
                    }
                    rowHtml = `
                        <td>${index + 1}</td>
                        <td>${s.nis_no}</td>
                        <td>${s.surname}</td>
                        <td>${s.other_names}</td>
                        <td>${rankBadge(s.rank)}</td>
                        <td>${s.phone_no || ''}</td>
                        <td>${exitReason}</td>
                        <td>${exitDate || ''}</td>
                        <td>${statusHtml}</td>
                    `;
                } else {
                    let actionBtns = ``;
                    actionBtns += `<button class="btn btn-sm btn-primary mb-1" onclick="editStaff(${s.id})">Edit</button>`;

                    if (role === 'super_admin' || role === 'main_admin') {
                        actionBtns += `<button class="btn btn-sm btn-danger mb-1" onclick="deleteStaff(${s.id})">Del</button>`;
                        actionBtns += `<button class="btn btn-sm btn-dark mb-1" onclick="openMoveModal(${s.id})">Move</button>`;
                        actionBtns += `<button class="btn btn-sm btn-secondary mb-1" onclick="openHistoryModal(${s.id})">History</button>`;
                    }
                    
                    if (s.out_request_status === 'Pending') {
                        if (role === 'super_admin' || role === 'main_admin') {
                            actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openReviewExitModal(${s.id}, '${s.out_request_date}', '${s.out_request_reason}')">Review Exit</button>`;
                        } else {
                            actionBtns += `<span class="badge bg-warning text-dark">Exit Pending</span>`;
                        }
                    } else {
                        actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openOutModal(${s.id})">Out</button>`;
                    }

                    rowHtml = `
                        <td>${index + 1}</td>
                        <td>${s.nis_no}</td>
                        <td>${s.surname} ${s.other_names}</td>
                        <td>${rankBadge(s.rank)}</td>
                        <td>${dates}</td>
                        <td>${s.office || ''}</td>
                        <td>${location}</td>
                        <td>${s.phone_no || ''}</td>
                        <td>${actionBtns}</td>
                    `;
                }

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        async function showOfficeSummary(officeName) {
            if (!officeName) return;
            const titleEl = document.getElementById('officeSummaryTitle');
            const canvas = document.getElementById('officeSummaryChart');
            if (titleEl) {
                titleEl.classList.remove('d-none');
                titleEl.textContent = `Personnel Summary - ${officeName} (loading...)`;
            }
            if (!canvas) return;

            const params = new URLSearchParams();
            params.append('status', 'active');
            params.append('office', officeName);

            try {
                const res = await fetch(`${API_URL}/staff?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    console.error('Failed to load staff for office', officeName, res.status);
                    if (titleEl) titleEl.textContent = `Personnel Summary - ${officeName} (failed to load)`;
                    return;
                }
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    if (titleEl) titleEl.textContent = `Personnel Summary - ${officeName} (no active personnel)`;
                    if (officeSummaryChart) {
                        officeSummaryChart.data.labels = [];
                        officeSummaryChart.data.datasets[0].data = [];
                        officeSummaryChart.update();
                    }
                    canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                const rankCounts = {};
                data.forEach(s => {
                    const rank = s.rank || '';
                    rankCounts[rank] = (rankCounts[rank] || 0) + 1;
                });

                const labels = [];
                const values = [];
                RANKS.forEach(r => {
                    const count = rankCounts[r] || 0;
                    if (count > 0) {
                        labels.push(r);
                        values.push(count);
                    }
                });
                Object.entries(rankCounts).forEach(([rank, count]) => {
                    if (count <= 0) return;
                    if (!labels.includes(rank)) {
                        labels.push(rank);
                        values.push(count);
                    }
                });

                const ctx = canvas.getContext('2d');
                const colors = labels.map(label => {
                    const text = label || '';
                    const red = ['DCG'];
                    const green = ['ACG', 'CIS', 'DCI', 'ACI'];
                    const blue = ['CSI', 'SI', 'DSI', 'ASI1', 'ASI 1', 'ASI2', 'ASI 2'];
                    const yellow = ['II', 'AII', 'IA1', 'IA 1', 'IA2', 'IA 2', 'IA3', 'IA 3'];
                    if (red.includes(text)) return 'rgba(220,53,69,0.85)';
                    if (green.includes(text)) return 'rgba(25,135,84,0.85)';
                    if (blue.includes(text)) return 'rgba(13,110,253,0.85)';
                    if (yellow.includes(text)) return 'rgba(255,193,7,0.85)';
                    return 'rgba(108,117,125,0.85)';
                });

                if (titleEl) titleEl.textContent = `Personnel Summary - ${officeName}`;

                if (officeSummaryChart) {
                    officeSummaryChart.data.labels = labels;
                    officeSummaryChart.data.datasets[0].data = values;
                    officeSummaryChart.update();
                } else {
                    officeSummaryChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: colors
                            }]
                        },
                        options: {
                            aspectRatio: 4,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                }
                canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                console.error('Error loading office summary', e);
                if (titleEl) titleEl.textContent = `Personnel Summary - ${officeName} (error)`;
            }
        }

        let staffCanEditRank = false;
        let staffCanEditDopp = false;

        async function loadStaffEditSettings() {
            if (role !== 'super_admin') return;
            try {
                const res = await fetch(`${API_URL}/settings/staff-edit`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const data = await res.json();
                const rankCb = document.getElementById('globalAllowEditRank');
                const doppCb = document.getElementById('globalAllowEditDopp');
                if (rankCb) rankCb.checked = !!data.allow_edit_rank;
                if (doppCb) doppCb.checked = !!data.allow_edit_dopp;
            } catch (e) { console.error(e); }
        }

        async function updateStaffEditSettings() {
            if (role !== 'super_admin') return;
            const rankCb = document.getElementById('globalAllowEditRank');
            const doppCb = document.getElementById('globalAllowEditDopp');
            const statusEl = document.getElementById('staffEditSettingsStatus');
            const payload = {
                allow_edit_rank: rankCb && rankCb.checked,
                allow_edit_dopp: doppCb && doppCb.checked
            };
            try {
                if (statusEl) statusEl.textContent = "Saving...";
                const res = await fetch(`${API_URL}/settings/staff-edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    if (statusEl) statusEl.textContent = "Saved.";
                } else {
                    if (statusEl) statusEl.textContent = "Failed to save settings.";
                }
            } catch (e) {
                console.error(e);
                if (statusEl) statusEl.textContent = "Error saving settings.";
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            console.log("Submitting form..."); // Debug

            const id = document.getElementById('staffId').value;
            
            const payload = {
                nis_no: document.getElementById('nis_no').value,
                surname: document.getElementById('surname').value,
                other_names: document.getElementById('other_names').value,
                rank: document.getElementById('rank').value,
                gender: document.getElementById('gender').value,
                dob: userDateToIsoOrNull(document.getElementById('dob').value),
                phone_no: document.getElementById('phone_no').value,
                email: document.getElementById('email').value,
                qualification: document.getElementById('qualification').value,
                
                office: document.getElementById('office').value,
                dofa: userDateToIsoOrNull(document.getElementById('dofa').value),
                dopa: userDateToIsoOrNull(document.getElementById('dopa').value),
                dopp: userDateToIsoOrNull(document.getElementById('dopp').value),
                
                state_id: document.getElementById('state_id').value || null,
                lga_id: document.getElementById('lga_id').value || null,
                home_town: document.getElementById('home_town').value,
                next_of_kin: document.getElementById('next_of_kin').value,
                nok_phone: document.getElementById('nok_phone').value,
                remark: document.getElementById('remark').value,
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/staff/${id}` : `${API_URL}/staff`;

            try {
                const currentRole = localStorage.getItem('role');
                if (currentRole === 'staff') {
                    const restricted = ["office", "role", "exit_date", "exit_mode", "out_request_status"];
                    restricted.forEach(f => delete payload[f]);
                    if (!staffCanEditRank) delete payload["rank"];
                    if (!staffCanEditDopp) delete payload["dopp"];
                }
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    if (currentRole === 'staff') {
                        showView('success');
                    } else {
                        alert('Saved Successfully');
                        document.getElementById('staffForm').reset();
                        document.getElementById('staffId').value = '';
                        showList();
                        loadStaff();
                    }
                } else {
                    let err;
                    try {
                        err = await res.json();
                    } catch (_) {
                        err = null;
                    }
                    alert('Error: ' + (err && err.detail ? err.detail : 'Request failed'));
                }
            } catch (err) {
                console.error(err);
                alert('Request failed');
            }
        }

        async function editStaff(id) {
            try {
                console.log("Loading staff data for ID:", id);
                const res = await fetch(`${API_URL}/staff/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    throw new Error(`Failed to fetch staff data: ${res.status} ${res.statusText}`);
                }

                const s = await res.json();
                console.log("Staff data loaded:", s);
                
                document.getElementById('staffId').value = s.id;
                document.getElementById('nis_no').value = s.nis_no;
                document.getElementById('surname').value = s.surname;
                document.getElementById('other_names').value = s.other_names;
                document.getElementById('rank').value = s.rank;
                document.getElementById('gender').value = s.gender;
                document.getElementById('dob').value = isoToDmy(s.dob);
                document.getElementById('phone_no').value = s.phone_no;
                document.getElementById('email').value = s.email || "";
                document.getElementById('qualification').value = s.qualification;
                
                // For office, we might need to add it to options if not present
                const officeSel = document.getElementById('office');
                if(s.office && !Array.from(officeSel.options).some(o=>o.value===s.office)) {
                    officeSel.add(new Option(s.office, s.office));
                }
                officeSel.value = s.office || "";
                if (role === 'office_admin') {
                    officeSel.disabled = true;
                } else {
                    officeSel.disabled = false;
                }

                document.getElementById('dofa').value = isoToDmy(s.dofa);
                document.getElementById('dopa').value = isoToDmy(s.dopa);
                document.getElementById('dopp').value = isoToDmy(s.dopp);
                
                document.getElementById('state_id').value = s.state ? s.state.id : "";
                if (s.state && s.state.id) {
                    await loadLGAs(s.state.id);
                    document.getElementById('lga_id').value = s.lga ? s.lga.id : "";
                } else {
                    document.getElementById('lga_id').innerHTML = '<option value="">Select LGA...</option>';
                }
                
                document.getElementById('home_town').value = s.home_town || "";
                document.getElementById('next_of_kin').value = s.next_of_kin || "";
                document.getElementById('nok_phone').value = s.nok_phone || "";
                document.getElementById('remark').value = s.remark || "";
                
                const rankSelect = document.getElementById('rank');
                const doppInput = document.getElementById('dopp');

                if (role === 'staff') {
                    staffCanEditRank = !!s.allow_edit_rank;
                    staffCanEditDopp = !!s.allow_edit_dopp;
                    const officeEl = document.getElementById('office');
                    if (officeEl) officeEl.disabled = true;
                    if (rankSelect) {
                        rankSelect.disabled = !staffCanEditRank;
                        if (!staffCanEditRank) rankSelect.classList.add('bg-light');
                        else rankSelect.classList.remove('bg-light');
                    }
                    if (doppInput) {
                        if (staffCanEditDopp) {
                            doppInput.readOnly = false;
                            doppInput.classList.remove('bg-light');
                            doppInput.style.pointerEvents = '';
                        } else {
                            doppInput.readOnly = true;
                            doppInput.classList.add('bg-light');
                            doppInput.style.pointerEvents = 'none';
                        }
                    }
                } else {
                    staffCanEditRank = false;
                    staffCanEditDopp = false;
                    if (rankSelect) {
                        rankSelect.disabled = false;
                        rankSelect.classList.remove('bg-light');
                    }
                    if (doppInput) {
                        doppInput.readOnly = false;
                        doppInput.classList.remove('bg-light');
                        doppInput.style.pointerEvents = '';
                    }
                }

                showAddForm(true);
                document.getElementById('formTitle').textContent = "Edit Personnel";
            } catch (err) { 
                console.error("Error in editStaff:", err);
                if (role === 'staff') {
                    // ignore error
                } else {
                    alert('Failed to load staff data');
                }
            }
        }

        // --- Move / History / View Modals Logic ---

        // Initialize Modals
        let moveModalInstance;
        let historyModalInstance;
        let viewModalInstance;
        let editRequestModalInstance;
        let editRequestsCache = {};

        document.addEventListener('DOMContentLoaded', () => {
             const moveEl = document.getElementById('moveModal');
             if (moveEl) {
                 moveModalInstance = new bootstrap.Modal(moveEl);
                 window.moveModalInstance = moveModalInstance;
             }

             const histEl = document.getElementById('historyModal');
             if (histEl) {
                 historyModalInstance = new bootstrap.Modal(histEl);
                 window.historyModalInstance = historyModalInstance;
             }

             const editReqEl = document.getElementById('editRequestModal');
             if (editReqEl) {
                 editRequestModalInstance = new bootstrap.Modal(editReqEl);
                 window.editRequestModalInstance = editRequestModalInstance;
             }

             const viewEl = document.getElementById('viewStaffModal');
             if (viewEl) {
                 viewModalInstance = new bootstrap.Modal(viewEl);
                 window.viewModalInstance = viewModalInstance;
             }
             
             initSortable();
        });

        async function openMoveModal(id) {
            document.getElementById('moveStaffId').value = id;
            document.getElementById('moveDate').value = "";
            document.getElementById('moveRemarks').value = "";
            
            // Load offices
            const select = document.getElementById('moveOfficeSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            select.disabled = true;

            try {
                const res = await fetch(`${API_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const offices = await res.json();
                    select.innerHTML = '<option value="">Select New Office</option>';
                    offices.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.name;
                        opt.textContent = o.name;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">Error loading offices</option>';
                }
            } catch(e) {
                console.error(e);
                select.innerHTML = '<option value="">Error loading offices</option>';
            } finally {
                select.disabled = false;
            }
            
            moveModalInstance.show();
        }

        async function submitMove() {
            const staffId = document.getElementById('moveStaffId').value;
            const newOffice = document.getElementById('moveOfficeSelect').value;
            const dateStr = document.getElementById('moveDate').value;
            const remarks = document.getElementById('moveRemarks').value;

            if (!newOffice) {
                alert("Please select a new office");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/staff/${staffId}/move`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        office: newOffice,
                        date: userDateToIsoOrNull(dateStr), // Convert dd/mm/yyyy to YYYY-MM-DD
                        remarks: remarks
                    })
                });

                if (res.ok) {
                    alert("Staff moved successfully");
                    moveModalInstance.hide();
                    loadStaff(); // Refresh list
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Move failed"));
                }
            } catch(e) {
                console.error(e);
                alert("Request failed");
            }
        }

        async function openHistoryModal(id) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';
            historyModalInstance.show();

            try {
                const res = await fetch(`${API_URL}/staff/${id}/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const history = await res.json();
                    tbody.innerHTML = '';
                    if (Array.isArray(history) && history.length === 0) {
                        try {
                            const staffRes = await fetch(`${API_URL}/staff/${id}`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (staffRes.ok) {
                                const s = await staffRes.json();
                                const dateStr = isoToDmy(s.dopp);
                                const office = s.office || '-';
                                if (dateStr || office !== '-') {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${dateStr || '-'}</td>
                                        <td>Current Posting</td>
                                        <td>-</td>
                                        <td>${office}</td>
                                        <td>-</td>
                                    `;
                                    tbody.appendChild(tr);
                                    return;
                                }
                            }
                        } catch (e) {
                            console.error(e);
                        }
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No history found</td></tr>';
                        return;
                    }
                    history.forEach(h => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${isoToDmy(h.action_date) || '-'}</td>
                            <td>${h.action_type}</td>
                            <td>${h.from_office || '-'}</td>
                            <td>${h.to_office || '-'}</td>
                            <td>${h.remarks || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load history</td></tr>';
                }
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading history</td></tr>';
            }
        }

        async function openViewModal(id) {
            const body = document.getElementById('viewStaffBody');
            body.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Loading...</p></div>';
            viewModalInstance.show();

            try {
                const res = await fetch(`${API_URL}/staff/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const s = await res.json();
                    
                    const renderField = (label, value) => `
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold small text-muted">${label}</label>
                            <div class="border-bottom pb-1">${value || '-'}</div>
                        </div>
                    `;
                    
                    body.innerHTML = `
                        <div class="row">
                            <div class="col-12 mb-4 text-center">
                                <h4 class="mb-0">${s.surname} ${s.other_names}</h4>
                                <span class="badge bg-primary">${s.rank || 'No Rank'}</span>
                                <span class="badge bg-secondary">${s.nis_no || 'No NIS'}</span>
                            </div>
                            ${renderField('Gender', s.gender)}
                            ${renderField('Date of Birth', isoToDmy(s.dob))}
                            ${renderField('Phone Number', s.phone_no)}
                            ${renderField('Email', s.email)}
                            ${renderField('Qualification', s.qualification)}
                            ${renderField('Current Office', s.office)}
                            <div class="col-12"><hr></div>
                            ${renderField('Date of First Appt', isoToDmy(s.dofa))}
                            ${renderField('Date of Present Appt', isoToDmy(s.dopa))}
                            ${renderField('Date of Present Posting', isoToDmy(s.dopp))}
                            <div class="col-12"><hr></div>
                            ${renderField('State of Origin', s.state ? s.state.name : '')}
                            ${renderField('LGA', s.lga ? s.lga.name : '')}
                            ${renderField('Home Town', s.home_town)}
                            <div class="col-12"><hr></div>
                            ${renderField('Next of Kin', s.next_of_kin)}
                            ${renderField('NoK Phone', s.nok_phone)}
                            <div class="col-12 mt-3">
                                <label class="fw-bold small text-muted">Remarks</label>
                                <div class="p-2 bg-light rounded">${s.remark || 'No remarks'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    body.innerHTML = '<div class="alert alert-danger">Failed to load details</div>';
                }
            } catch(e) {
                console.error(e);
                body.innerHTML = '<div class="alert alert-danger">Error loading details</div>';
            }
        }
        
        function initSortable() {
            const list = document.getElementById('exportColumnList');
            if (list) {
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'bg-light'
                });
            }
        }

        function showList() {
            const listTab = new bootstrap.Tab(document.getElementById('list-tab'));
            listTab.show();
            document.getElementById('formTitle').textContent = "Add New Personnel";
            document.getElementById('staffId').value = '';
            document.getElementById('staffForm').reset();
        }

        async function showAddForm(isEdit = false) {
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
            
            if (!isEdit) {
                document.getElementById('staffForm').reset();
                document.getElementById('staffId').value = '';
                document.getElementById('formTitle').textContent = "Add New Personnel";
            }

            // If office admin, pre-select office
            if (role === 'office_admin') {
                if (!currentOfficeName) await fetchUserOffice();
                
                if (currentOfficeName) {
                    const officeSel = document.getElementById('office');
                    // Add option if not exists
                    if(!Array.from(officeSel.options).some(o=>o.value===currentOfficeName)) {
                        officeSel.add(new Option(currentOfficeName, currentOfficeName));
                    }
                    if (!isEdit) {
                        officeSel.value = currentOfficeName;
                    }
                    officeSel.disabled = true;
                }
            }
        }

        async function deleteStaff(id) {
            if (!confirm('Are you sure you want to delete this personnel?')) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadStaff();
                } else {
                    alert('Failed to delete');
                }
            } catch (err) { console.error(err); }
        }

        // Import
        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files[0]) {
                alert("Please select a file");
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const res = await fetch(`${API_URL}/import/excel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                let result;
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    result = await res.json();
                } else {
                    result = { detail: await res.text() };
                }

                const resDiv = document.getElementById('importResult');
                resDiv.innerHTML = `<div class="alert alert-${res.ok ? 'success':'danger'}">
                    ${result.detail || `Imported: ${result.imported_count}, Errors: ${result.errors ? result.errors.length : 0}`}
                </div>`;
                if (res.ok) loadStaff();
            } catch (err) {
                console.error(err);
                alert("Upload failed: " + err.message);
            }
        }
        
        function openExportModal(type) {
            document.getElementById('exportType').value = type;

            const nameColumns = new Set(['nis_no', 'surname', 'other_names']);
            const checkboxes = document.querySelectorAll('#exportColumnList input[type="checkbox"]');
            if (currentStatus === 'exited') {
                checkboxes.forEach(cb => {
                    cb.checked = nameColumns.has(cb.value);
                });
            } else {
                checkboxes.forEach(cb => cb.checked = true);
            }

            exportModal.show();
        }

        function moveColumn(btn, direction) {
            const li = btn.closest('li');
            const parent = li.parentNode;
            if (direction === -1) {
                // Move Up
                const prev = li.previousElementSibling;
                if (prev) {
                    parent.insertBefore(li, prev);
                }
            } else {
                // Move Down
                const next = li.nextElementSibling;
                if (next) {
                    parent.insertBefore(next, li);
                }
            }
        }

        function confirmExport() {
            const type = document.getElementById('exportType').value;
            const checkboxes = document.querySelectorAll('#exportColumnList input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const mergeName = document.getElementById('merge_name').checked;
            
            if (selected.length === 0) {
                alert("Please select at least one column");
                return;
            }
            
            exportData(type, selected, mergeName);
            exportModal.hide();
        }

        async function exportData(type, columns, mergeName) {
            const q = document.getElementById('searchInput').value;
            
            const ranks = [];
            document.querySelectorAll('.filter-rank-cb:checked').forEach(cb => ranks.push(cb.value));
            
            const offices = [];
            document.querySelectorAll('.filter-office-cb:checked').forEach(cb => offices.push(cb.value));
            
            const params = new URLSearchParams();
            if (q) params.append('q', q);
            ranks.forEach(r => params.append('rank', r));
            offices.forEach(o => params.append('office', o));
            
            const doppOrder = document.getElementById('sortDopp').value;
            if (doppOrder) params.append('dopp_order', doppOrder);
            if (currentStatus === 'exited') {
                const exitFrom = document.getElementById('exitFrom');
                const exitTo = document.getElementById('exitTo');
                const fromVal = exitFrom ? exitFrom.value : '';
                const toVal = exitTo ? exitTo.value : '';
                if (fromVal) params.append('exit_from', userDateToIsoOrNull(fromVal));
                if (toVal) params.append('exit_to', userDateToIsoOrNull(toVal));
            }
            if (!q && currentStatusFilter) params.append('completeness', currentStatusFilter);
            if (currentStatus) params.append('status', currentStatus);
            if (columns && columns.length) params.append('columns', columns.join(','));
            if (mergeName) params.append('merge_name', '1');

            const url = `${API_URL}/export/${type}?${params.toString()}`;
            
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    let msg = `Export failed (status ${res.status})`;
                    try {
                        const err = await res.json();
                        if (err && err.detail) msg = err.detail;
                    } catch(e) {
                        try {
                            const text = await res.text();
                            if (text) msg = text.slice(0, 300);
                        } catch(_) {}
                    }
                    alert(msg);
                    return;
                }
                const blob = await res.blob();
                const disposition = res.headers.get('Content-Disposition') || '';
                let filename = '';
                const match = disposition.match(/filename="?([^"]+)"?/i);
                if (match && match[1]) filename = match[1];
                if (!filename) {
                    const ext = type === 'pdf' ? 'pdf' : 'xlsx';
                    filename = `staff_export_${new Date().toISOString().slice(0,10)}.${ext}`;
                }
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                console.error(e);
                alert('Export failed: ' + e.message);
            }
        }

        async function loadAuditLogs() {
            try {
                const res = await fetch(`${API_URL}/audit-logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const logs = await res.json();
                    const tbody = document.getElementById('auditTableBody');
                    tbody.innerHTML = '';
                    logs.forEach(l => {
                        const tr = document.createElement('tr');
                        let actionsHtml = '';
                        let reqId = null;
                        if (l.details) {
                            const m = String(l.details).match(/EDIT_REQUEST_ID=(\d+)/);
                            if (m) {
                                reqId = parseInt(m[1], 10);
                            }
                        }
                        if (l.action === 'UPDATE_REQUEST' && reqId) {
                            actionsHtml = `
                                <button class="btn btn-sm btn-success me-1" onclick="approveEditRequest(${reqId})">Approve</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="rejectEditRequest(${reqId})">Reject</button>
                            `;
                        }
                        tr.innerHTML = `
                            <td>${new Date(l.timestamp).toLocaleString()}</td>
                            <td>${l.action}</td>
                            <td>${l.target}</td>
                            <td>${l.details || ''}</td>
                            <td>${actionsHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function fetchApprovalCounts() {
            try {
                const [editRes, exitRes] = await Promise.all([
                    fetch(`${API_URL}/admin/edit-requests`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_URL}/admin/exit-requests`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                let editCount = 0;
                let exitCount = 0;
                if (editRes.ok) {
                    const editData = await editRes.json();
                    if (Array.isArray(editData)) editCount = editData.length;
                }
                if (exitRes.ok) {
                    const exitData = await exitRes.json();
                    if (Array.isArray(exitData)) exitCount = exitData.length;
                }
                updateApprovalCounters(editCount, exitCount);
            } catch (e) {
                console.error(e);
            }
        }

        function updateApprovalCounters(editCount, exitCount) {
            const approvalsCounter = document.getElementById('approvalsCounter');
            const editCounter = document.getElementById('editRequestsCounter');
            const exitCounter = document.getElementById('exitRequestsCounter');

            let currentEdit = editCounter ? parseInt(editCounter.textContent || '0', 10) || 0 : 0;
            let currentExit = exitCounter ? parseInt(exitCounter.textContent || '0', 10) || 0 : 0;

            if (typeof editCount === 'number') {
                currentEdit = editCount;
                if (editCounter) {
                    editCounter.textContent = editCount;
                    editCounter.classList.toggle('d-none', editCount === 0);
                }
            } else if (editCounter) {
                editCounter.classList.toggle('d-none', currentEdit === 0);
            }

            if (typeof exitCount === 'number') {
                currentExit = exitCount;
                if (exitCounter) {
                    exitCounter.textContent = exitCount;
                    exitCounter.classList.toggle('d-none', exitCount === 0);
                }
            } else if (exitCounter) {
                exitCounter.classList.toggle('d-none', currentExit === 0);
            }

            if (approvalsCounter) {
                const total = currentEdit + currentExit;
                approvalsCounter.textContent = total;
                approvalsCounter.classList.toggle('d-none', total === 0);
            }
        }
        
        async function loadExitRequests() {
            try {
                const res = await fetch(`${API_URL}/admin/exit-requests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const data = await res.json();
                const tbody = document.getElementById('exitRequestsBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                data.forEach((s, idx) => {
                    const tr = document.createElement('tr');
                    const exitDate = isoToDmy(s.out_request_date);
                    const exitMode = s.out_request_reason || '';
                    const requestedText = exitDate || exitMode ? `${exitMode || ''} ${exitDate || ''}`.trim() : '';
                    tr.innerHTML = `
                        <td>${idx + 1}</td>
                        <td>${s.nis_no}</td>
                        <td>${s.surname} ${s.other_names}</td>
                        <td>${s.office || ''}</td>
                        <td>${requestedText}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-warning" onclick="openReviewExitModal(${s.id}, '${s.out_request_date}', '${s.out_request_reason}')">Review</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                updateApprovalCounters(undefined, Array.isArray(data) ? data.length : 0);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadEditRequests() {
            try {
                const res = await fetch(`${API_URL}/admin/edit-requests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const data = await res.json();
                editRequestsCache = {};
                const mainBody = document.getElementById('editRequestsBody');
                const inlineBody = document.getElementById('editRequestsBodyInline');
                if (!mainBody && !inlineBody) return;

                const bodies = [mainBody, inlineBody].filter(Boolean);
                bodies.forEach(tb => tb.innerHTML = '');

                data.forEach((r, idx) => {
                    editRequestsCache[r.id] = r;
                    const changes = Object.entries(r.data || {})
                        .map(([k, v]) => `${k}: ${v}`)
                        .join(', ');
                    bodies.forEach(tb => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${idx + 1}</td>
                            <td>${r.staff_nis}</td>
                            <td>${r.staff_name}</td>
                            <td class="text-truncate" style="max-width: 320px;" title="${changes}">${changes}</td>
                            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="openEditRequestModal(${r.id})">View</button>
                            </td>
                        `;
                        tb.appendChild(tr);
                    });
                });
                updateApprovalCounters(Array.isArray(data) ? data.length : 0, undefined);
            } catch (e) {
                console.error(e);
            }
        }

        async function approveEditRequest(id) {
            if (!confirm('Approve this edit request?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/edit-requests/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert('Request approved');
                    if (editRequestModalInstance) editRequestModalInstance.hide();
                    loadEditRequests();
                    loadStaff();
                } else {
                    let err;
                    try { err = await res.json(); } catch (_) { err = null; }
                    alert(err && err.detail ? err.detail : 'Approve failed');
                }
            } catch (e) {
                console.error(e);
                alert('Approve failed');
            }
        }

        async function rejectEditRequest(id) {
            if (!confirm('Reject this edit request?')) return;
            try {
                const res = await fetch(`${API_URL}/admin/edit-requests/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    alert('Request rejected');
                    if (editRequestModalInstance) editRequestModalInstance.hide();
                    loadEditRequests();
                } else {
                    let err;
                    try { err = await res.json(); } catch (_) { err = null; }
                    alert(err && err.detail ? err.detail : 'Reject failed');
                }
            } catch (e) {
                console.error(e);
                alert('Reject failed');
            }
        }

        async function openEditRequestModal(id) {
            const r = editRequestsCache[id];
            if (!r || !editRequestModalInstance) return;
            const idInput = document.getElementById('editRequestModalId');
            const nisEl = document.getElementById('editReqStaffNis');
            const nameEl = document.getElementById('editReqStaffName');
            const createdEl = document.getElementById('editReqCreatedAt');
            const body = document.getElementById('editReqChangesBody');
            if (idInput) idInput.value = id;
            if (nisEl) nisEl.textContent = r.staff_nis || '';
            if (nameEl) nameEl.textContent = r.staff_name || '';
            if (createdEl) createdEl.textContent = r.created_at ? new Date(r.created_at).toLocaleString() : '';
            if (body) {
                body.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
                let staff = null;
                try {
                    if (r.staff_id) {
                        const res = await fetch(`${API_URL}/staff/${r.staff_id}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            staff = await res.json();
                        }
                    }
                } catch (e) {
                    console.error(e);
                }

                body.innerHTML = '';
                const entries = Object.entries(r.data || {});

                const fieldLabels = {
                    nis_no: "NIS No",
                    surname: "Surname",
                    other_names: "Other Names",
                    rank: "Rank",
                    gender: "Gender",
                    dob: "Date of Birth",
                    phone_no: "Phone Number",
                    email: "Email",
                    qualification: "Qualification",
                    office: "Office",
                    state_id: "State",
                    lga_id: "LGA",
                    home_town: "Home Town",
                    next_of_kin: "Next of Kin",
                    nok_phone: "NoK Phone",
                    remark: "Remarks",
                    dofa: "Date of First Appt",
                    dopa: "Date of Present Appt",
                    dopp: "Date of Present Posting",
                    exit_date: "Exit Date",
                    out_request_date: "Exit Request Date",
                    exit_mode: "Exit Mode",
                    allow_edit_rank: "Allow Edit Rank",
                    allow_edit_dopp: "Allow Edit Dopp"
                };

                function getFieldLabel(key) {
                    return fieldLabels[key] || key;
                }

                let statesList = (typeof allStates !== 'undefined') ? allStates : [];
                if (!Array.isArray(statesList) || statesList.length === 0) {
                    try {
                        const res = await fetch(`${API_URL}/states`);
                        if (res.ok) {
                            statesList = await res.json();
                            // Update global allStates if possible, but keep local safe
                            if (typeof allStates !== 'undefined') allStates = statesList;
                        }
                    } catch (e) {
                        console.error("Failed to fetch states", e);
                        statesList = [];
                    }
                }

                const stateNameMap = {};
                if (Array.isArray(statesList)) {
                    statesList.forEach(st => {
                        if (st && typeof st.id !== 'undefined') {
                            stateNameMap[st.id] = st.name;
                        }
                    });
                }

                const lgaNameMap = {};
                const stateIdsForLgas = new Set();
                if (staff && staff.state && staff.state.id) {
                    stateIdsForLgas.add(staff.state.id);
                }
                entries.forEach(([k, v]) => {
                    if (k === 'state_id' && v) {
                        const idNum = typeof v === 'number' ? v : parseInt(String(v), 10);
                        if (!isNaN(idNum)) {
                            stateIdsForLgas.add(idNum);
                        }
                    }
                });

                for (const stateId of stateIdsForLgas) {
                    try {
                        const res = await fetch(`${API_URL}/states/${stateId}/lgas`);
                        if (res.ok) {
                            const lgas = await res.json();
                            lgas.forEach(l => {
                                if (l && typeof l.id !== 'undefined') {
                                    lgaNameMap[l.id] = l.name;
                                }
                            });
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }

                function normalizeValue(key, value) {
                    if (value === null || value === undefined) return '';
                    if (key === 'state_id') {
                        const idNum = typeof value === 'number' ? value : parseInt(String(value), 10);
                        if (!isNaN(idNum) && stateNameMap[idNum]) {
                            return stateNameMap[idNum];
                        }
                    }
                    if (key === 'lga_id') {
                        const idNum = typeof value === 'number' ? value : parseInt(String(value), 10);
                        if (!isNaN(idNum) && lgaNameMap[idNum]) {
                            return lgaNameMap[idNum];
                        }
                    }
                    if (typeof value === 'boolean') return value ? '1' : '0';
                    if (typeof value === 'number') return String(value);
                    let s = String(value).trim();
                    if (key === 'allow_edit_rank' || key === 'allow_edit_dopp') {
                        const lower = s.toLowerCase();
                        if (lower === 'true' || lower === '1' || lower === 'yes' || lower === 'on') return '1';
                        if (lower === 'false' || lower === '0' || lower === 'no' || lower === 'off') return '0';
                    }
                    if (key === 'dofa' || key === 'dopa' || key === 'dopp' || key === 'dob' || key === 'exit_date' || key === 'out_request_date') {
                        const d = new Date(s);
                        if (!isNaN(d.getTime())) {
                            return d.toISOString().slice(0, 10);
                        }
                    }
                    return s;
                }

                const changedEntries = [];
                entries.forEach(([k, v]) => {
                    if (!staff) {
                        changedEntries.push([k, null, v]);
                        return;
                    }
                    let currentVal = staff[k];
                    if (k === 'state_id' && staff.state && typeof staff.state.id !== 'undefined') {
                        currentVal = staff.state.id;
                    } else if (k === 'lga_id' && staff.lga && typeof staff.lga.id !== 'undefined') {
                        currentVal = staff.lga.id;
                    }
                    if (currentVal && typeof currentVal === 'object') {
                        if ('id' in currentVal) {
                            currentVal = currentVal.id;
                        } else if ('name' in currentVal) {
                            currentVal = currentVal.name;
                        }
                    }
                    const newNorm = normalizeValue(k, v);
                    const currentNorm = normalizeValue(k, currentVal);
                    if (newNorm !== currentNorm) {
                        changedEntries.push([k, currentVal, v]);
                    }
                });

                if (changedEntries.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="3">No field changes found</td>';
                    body.appendChild(tr);
                } else {
                    changedEntries.forEach(([k, oldVal, newVal]) => {
                        const tr = document.createElement('tr');
                        const oldDisplay = normalizeValue(k, oldVal);
                        const newDisplay = normalizeValue(k, newVal);
                        const label = getFieldLabel(k);
                        tr.innerHTML = `<td>${label}</td><td>${oldDisplay}</td><td>${newDisplay}</td>`;
                        body.appendChild(tr);
                    });
                }
            }
            editRequestModalInstance.show();
        }

        function approveEditRequestFromModal() {
            const idInput = document.getElementById('editRequestModalId');
            if (!idInput || !idInput.value) return;
            approveEditRequest(parseInt(idInput.value, 10));
        }

        function rejectEditRequestFromModal() {
            const idInput = document.getElementById('editRequestModalId');
            if (!idInput || !idInput.value) return;
            rejectEditRequest(parseInt(idInput.value, 10));
        }

        function openOutModal(id) {
            document.getElementById('outStaffId').value = id;
            document.getElementById('outReason').value = 'Posted Out';
            document.getElementById('outDate').value = '';
            outModal.show();
        }

        async function confirmOut() {
            const id = document.getElementById('outStaffId').value;
            const reason = document.getElementById('outReason').value;
            const dateStr = document.getElementById('outDate').value;
            
            if (!dateStr) {
                alert("Please select a date");
                return;
            }

            if (!confirm(`Are you sure you want to mark this personnel as ${reason}?`)) return;

            const isRequest = (role === 'office_admin');
            const url = isRequest ? `${API_URL}/staff/${id}/exit-request` : `${API_URL}/staff/${id}`; // Super admin uses direct update for now, or we can use exit-request for them too?
            // Actually, existing logic used PUT /staff/{id}.
            // For office_admin, we use POST /staff/{id}/exit-request
            
            try {
                let res;
                if (isRequest) {
                     res = await fetch(`${API_URL}/staff/${id}/exit-request`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ exit_date: dateStr, exit_mode: reason })
                    });
                } else {
                     // Super admin direct update (legacy way, or we can use new endpoints?)
                     // Use legacy PUT for super admin direct exit
                     res = await fetch(`${API_URL}/staff/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ exit_date: dateStr, exit_mode: reason })
                    });
                }

                if (res.ok) {
                    alert(isRequest ? "Exit request submitted for approval" : "Personnel status updated successfully");
                    outModal.hide();
                    loadStaff(); 
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed to update"));
                }
            } catch (e) {
                console.error(e);
                alert("An error occurred");
            }
        }

        function openReviewExitModal(id, date, reason) {
            document.getElementById('reviewStaffId').value = id;
            document.getElementById('reviewExitDetails').textContent = `Reason: ${reason}, Effective: ${isoToDmy(date)}`;
            reviewExitModal.show();
        }

        async function processExitRequest(action) {
            const id = document.getElementById('reviewStaffId').value;
            if(!confirm(`Are you sure you want to ${action} this request?`)) return;
            
            const endpoint = action === 'approve' ? 'exit-approve' : 'exit-reject';
                
            try {
                const res = await fetch(`${API_URL}/staff/${id}/${endpoint}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (res.ok) {
                    alert(`Request ${action}d successfully`);
                    reviewExitModal.hide();
                    loadStaff();
                    await loadExitRequests();
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed"));
                }
            } catch(e) { console.error(e); }
        }
        
        async function loadPrivileges() {
            if (role !== 'super_admin') return;
            try {
                await loadStaffEditSettings();

                const res = await fetch(`${API_URL}/staff?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Failed to fetch staff");
                const items = await res.json();
                
                const tbody = document.getElementById('privilegesTableBody');
                tbody.innerHTML = '';
                
                items.forEach(s => {
                    const tr = document.createElement('tr');
                    const isSuper = s.role === 'super_admin';
                    
                    tr.innerHTML = `
                        <td>${s.nis_no}</td>
                        <td>${s.surname} ${s.other_names}</td>
                        <td>${s.rank}</td>
                        <td><span class="badge bg-${s.role === 'super_admin' ? 'danger' : (s.role === 'office_admin' ? 'warning' : (s.role === 'main_admin' ? 'primary' : 'info'))}">${roleLabel(s.role)}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="updateRole(${s.id}, 'staff')" ${s.role === 'staff' ? 'disabled' : ''}>Staff</button>
                                <button class="btn btn-outline-warning" onclick="updateRole(${s.id}, 'office_admin')" ${s.role === 'office_admin' ? 'disabled' : ''}>Office Admin</button>
                                <button class="btn btn-outline-primary" onclick="updateRole(${s.id}, 'main_admin')" ${s.role === 'main_admin' ? 'disabled' : ''}>Main Admin</button>
                                <button class="btn btn-outline-danger" onclick="updateRole(${s.id}, 'super_admin')" ${s.role === 'super_admin' ? 'disabled' : ''}>Super Admin</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }
        
        async function updateRole(id, newRole) {
            if(!confirm(`Change role to ${newRole}?`)) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if(res.ok) {
                    loadPrivileges();
                } else {
                    alert('Failed to update role');
                }
            } catch(e) { console.error(e); }
        }

        // Leave Management
        async function loadLeaveRequests() {
            try {
                const res = await fetch(`${API_URL}/leaves`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const items = await res.json();
                    const tbody = document.getElementById('leaveTableBody');
                    tbody.innerHTML = '';
                    items.forEach(l => {
                        const tr = document.createElement('tr');
                        // Action buttons based on status and role
                        let actions = '';
                        if(role === 'super_admin' || role === 'office_admin') {
                            if(l.status === 'Pending') {
                                actions = `
                                    <button class="btn btn-sm btn-success" onclick="updateLeaveStatus(${l.id}, 'Approved')">Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="updateLeaveStatus(${l.id}, 'Rejected')">Reject</button>
                                `;
                            }
                        }
                        
                        tr.innerHTML = `
                            <td>${l.staff_name}</td>
                            <td>${l.leave_type}</td>
                            <td>${isoToDmy(l.start_date)}</td>
                            <td>${isoToDmy(l.end_date)}</td>
                            <td>${l.reason || ''}</td>
                            <td><span class="badge bg-${l.status === 'Approved' ? 'success' : (l.status === 'Rejected' ? 'danger' : 'warning')}">${l.status}</span></td>
                            <td>${actions}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function openLeaveModal() {
            document.getElementById('leaveForm').reset();
            
            // If admin, load staff list
            if(role !== 'staff') {
                document.getElementById('leaveStaffSelectDiv').classList.remove('d-none');
                await loadAllStaffForSelect();
            } else {
                document.getElementById('leaveStaffSelectDiv').classList.add('d-none');
            }

            if(!leaveModal) {
                 leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
            }
            leaveModal.show();
        }

        async function loadAllStaffForSelect() {
            const sel = document.getElementById('leaveStaffId');
            if(sel.options.length > 1) return; // Already loaded

            try {
                const res = await fetch(`${API_URL}/staff?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const items = await res.json();
                    items.forEach(s => {
                        const opt = new Option(`${s.surname} ${s.other_names} (${s.nis_no})`, s.id);
                        sel.add(opt);
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            const staffId = document.getElementById('leaveStaffId').value;
            
            if(!type || !start || !end) {
                alert("Please fill required fields");
                return;
            }
            
            // Convert dd/mm/yyyy to yyyy-mm-dd
            const isoStart = userDateToIsoOrNull(start);
            const isoEnd = userDateToIsoOrNull(end);

            if(!isoStart || !isoEnd) {
                 alert("Invalid date format");
                 return;
            }

            const payload = {
                leave_type: type,
                start_date: isoStart,
                end_date: isoEnd,
                reason: reason
            };
            
            if(role !== 'staff') {
                if(!staffId) {
                    alert("Please select personnel");
                    return;
                }
                payload.staff_id = parseInt(staffId);
            }

            try {
                const res = await fetch(`${API_URL}/leaves`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    alert("Leave request submitted");
                    leaveModal.hide();
                    loadLeaveRequests();
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed"));
                }
            } catch(e) { console.error(e); }
        }

        async function updateLeaveStatus(id, status) {
            if(!confirm(`Mark leave as ${status}?`)) return;
            try {
                 const res = await fetch(`${API_URL}/leaves/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ status: status })
                });
                if(res.ok) {
                    loadLeaveRequests();
                } else {
                    alert("Failed to update status");
                }
            } catch(e) { console.error(e); }
        }

        async function resetUserPassword(id) {
             if(!confirm("Reset password to default (NIS Number)?")) return;
             try {
                 const res = await fetch(`${API_URL}/staff/${id}/reset-password`, {
                     method: 'POST',
                     headers: { 'Authorization': `Bearer ${token}` }
                 });
                 if(res.ok) {
                     alert("Password reset successfully");
                 } else {
                     alert("Failed to reset password");
                 }
             } catch(e) { console.error(e); }
        }

        async function resetUserLogin(id) {
            if(!confirm("Reset login count for this user? They will be allowed to log in again.")) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/reset-login`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    alert("Login count reset successfully");
                } else {
                    const data = await res.json();
                    alert("Failed: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        function openChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            changePasswordModal.show();
        }

        async function submitChangePassword() {
            const oldPwd = document.getElementById('cpOldPassword').value;
            const newPwd = document.getElementById('cpNewPassword').value;
            const confirmPwd = document.getElementById('cpConfirmPassword').value;

            if(!oldPwd || !newPwd || !confirmPwd) {
                alert("All fields are required");
                return;
            }
            if(newPwd !== confirmPwd) {
                alert("New passwords do not match");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        old_password: oldPwd,
                        new_password: newPwd
                    })
                });

                const data = await res.json();
                if(res.ok) {
                    alert("Password changed successfully");
                    changePasswordModal.hide();
                } else {
                    alert("Error: " + (data.detail || "Failed to change password"));
                }
            } catch(e) {
                console.error(e);
                alert("Request failed");
            }
        }
    </script>
</body>
</html>
