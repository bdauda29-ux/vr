<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnel Information System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { 
            overflow-x: hidden; 
            padding-top: 60px; /* Space for fixed navbar */
        }
        
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .form-label { font-weight: 500; }
        .required:after { content: " *"; color: red; }
        .nav-link { cursor: pointer; }
        .small-font { font-size: 0.85em; }
        
        /* Responsive Adjustments */
        @media (max-width: 767.98px) {
            .table { font-size: 0.8rem; }
            h1.display-4 { font-size: 2.5rem; }
            .btn-group-sm > .btn, .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
            .card-body { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">VSS Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('dashboard')"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-people-fill me-1"></i> Personnel
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showPersonnelTab('list-tab')">Personnel List</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showPersonnelTab('form-tab')">Add New</a></li>
                            <li><a class="dropdown-item admin-only" href="#" onclick="showPersonnelTab('import-tab')">Bulk Import</a></li>
                            <li><a class="dropdown-item admin-only" href="#" onclick="showPersonnelTab('privileges-tab')">Privileges</a></li>
                            <li><a class="dropdown-item admin-only" href="#" onclick="showPersonnelTab('password-reset-tab')">Password Reset</a></li>
                        </ul>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#" onclick="showView('offices')"><i class="bi bi-building me-1"></i> Offices</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('leave')"><i class="bi bi-calendar-check me-1"></i> Leave</a>
                    </li>
                    <li class="nav-item admin-only">
                        <a class="nav-link" href="#" onclick="showView('audit')"><i class="bi bi-journal-text me-1"></i> Audit Log</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i> <span id="userDisplayNavbar">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="openChangePasswordModal()">Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
             <h4 class="mb-0" id="pageTitle">Dashboard</h4>
        </div>
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card text-white bg-primary mb-3 cursor-pointer" onclick="showView('personnel')" style="cursor: pointer;">
                                <div class="card-header" id="dash-card1-title">Total Personnel</div>
                                <div class="card-body">
                                    <h1 class="card-title display-4 fw-bold" id="dash-total-staff">0</h1>
                                    <p class="card-text">Click to view list</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card text-white bg-success mb-3 cursor-pointer" onclick="showView('offices')" style="cursor: pointer;">
                                <div class="card-header" id="dash-card2-title">Total Offices</div>
                                <div class="card-body">
                                    <h1 class="card-title display-4 fw-bold" id="dash-total-offices">0</h1>
                                    <p class="card-text" id="dash-card2-text">Click to view offices</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personnel View -->
                <div id="view-personnel" class="view-section d-none">
                    <ul class="nav nav-tabs mb-3" id="personnelTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button">Personnel List</button>
                        </li>
                        <li class="nav-item d-none" role="presentation">
                            <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button">Add / Edit Personnel</button>
                        </li>
                        <li class="nav-item admin-only" role="presentation">
                            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-pane" type="button">Bulk Import</button>
                        </li>
                        <li class="nav-item admin-only" role="presentation">
                            <button class="nav-link" id="privileges-tab" data-bs-toggle="tab" data-bs-target="#privileges-pane" type="button">Privileges</button>
                        </li>
                        <li class="nav-item admin-only" role="presentation">
                            <button class="nav-link" id="password-reset-tab" data-bs-toggle="tab" data-bs-target="#password-reset-pane" type="button">Password Reset</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="personnelTabContent">
                        <!-- List Pane -->
                        <div class="tab-pane fade show active" id="list-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <ul class="nav nav-pills mb-3" id="mainStatusTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" href="#" onclick="setMainStatus('active', this)">Active Personnel</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" onclick="setMainStatus('exited', this)">Posted Out / Exited</a>
                                        </li>
                                    </ul>
                                    <div class="row mb-3 g-2">
                                        <div class="col-12 col-md-3">
                                            <input type="text" id="searchInput" class="form-control" placeholder="Search surname, NIS...">
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <select id="filterRank" class="form-select" onchange="loadStaff()">
                                                <option value="">All Ranks</option>
                                            </select>
                                        </div>
                                        <div class="col-6 col-md-2">
                                            <select id="filterOffice" class="form-select" onchange="loadStaff()">
                                                <option value="">All Offices</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-md-1">
                                            <button class="btn btn-primary w-100" onclick="loadStaff()"><i class="bi bi-search"></i></button>
                                        </div>
                                        <div class="col-6 col-md-2 text-md-end">
                                            <button class="btn btn-success w-100" onclick="showAddForm()"><i class="bi bi-plus-lg"></i> Add</button>
                                        </div>
                                        <div class="col-6 col-md-2 text-md-end">
                                            <div class="btn-group w-100">
                                                <button class="btn btn-success btn-sm w-50" onclick="openExportModal('excel')"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                                                <button class="btn btn-danger btn-sm w-50" onclick="openExportModal('pdf')"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                                            </div>
                                        </div>
                                    </div>

                                    <ul class="nav nav-tabs mb-3" id="statusTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" href="#" onclick="setStatusFilter('completed', this)">Completed</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" onclick="setStatusFilter('incomplete', this)">Incomplete</a>
                                        </li>
                                    </ul>

                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>S/N</th>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Rank</th>
                                                    <th>DOFA / DOPA</th>
                                                    <th>Office</th>
                                                    <th>State/LGA</th>
                                                    <th>Phone</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="staffTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Pane -->
                        <div class="tab-pane fade" id="form-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0" id="formTitle">Add New Personnel</h5>
                                </div>
                                <div class="card-body">
                                    <form id="staffForm">
                                        <input type="hidden" id="staffId">
                                        
                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Personal Details</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label required">NIS/No</label>
                                                        <input type="text" class="form-control" id="nis_no" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label required">Surname</label>
                                                        <input type="text" class="form-control" id="surname" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label required">Other Names</label>
                                                        <input type="text" class="form-control" id="other_names" required>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Gender</label>
                                                        <select class="form-select" id="gender">
                                                            <option value="">Select...</option>
                                                            <option value="Male">Male</option>
                                                            <option value="Female">Female</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">DOB</label>
                                                        <input type="text" class="form-control date-picker" id="dob" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Phone No</label>
                                                        <input type="text" class="form-control" id="phone_no">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Qualification</label>
                                                        <select class="form-select" id="qualification">
                                                            <option value="">Select...</option>
                                                            <option value="B.Sc">B.Sc</option>
                                                            <option value="B.A">B.A</option>
                                                            <option value="B.Ed">B.Ed</option>
                                                            <option value="B.Tech">B.Tech</option>
                                                            <option value="M.Sc">M.Sc</option>
                                                            <option value="M.Tech">M.Tech</option>
                                                            <option value="PhD">PhD</option>
                                                            <option value="HND">HND</option>
                                                            <option value="ND">ND</option>
                                                            <option value="SSCE">SSCE</option>
                                                            <option value="MBA">MBA</option>
                                                            <option value="MPA">MPA</option>
                                                            <option value="PGD">PGD</option>
                                                            <option value="NCE">NCE</option>
                                                            <option value="LLB">LLB</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Official Info</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3">
                                                        <label class="form-label required">Rank</label>
                                                        <select class="form-select" id="rank" required>
                                                            <option value="">Select...</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Office</label>
                                                        <select class="form-select" id="office">
                                                            <option value="">Select...</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">DOFA</label>
                                                        <input type="text" class="form-control date-picker" id="dofa" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">DOPA</label>
                                                        <input type="text" class="form-control date-picker" id="dopa" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">DOPP</label>
                                                        <input type="text" class="form-control date-picker" id="dopp" placeholder="dd/mm/yyyy" inputmode="numeric">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card mb-3 shadow-sm border-light">
                                            <div class="card-header bg-light">
                                                <h6 class="card-title mb-0 text-primary">Origin & Kin</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label">State of Origin</label>
                                                        <select class="form-select" id="state_id" onchange="loadLGAs(this.value)">
                                                            <option value="">Select State...</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">LGA</label>
                                                        <select class="form-select" id="lga_id" disabled>
                                                            <option value="">Select State First</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label">Home Town</label>
                                                        <input type="text" class="form-control" id="home_town">
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Next of Kin Name</label>
                                                        <input type="text" class="form-control" id="next_of_kin">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Next of Kin Phone</label>
                                                        <input type="text" class="form-control" id="nok_phone">
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Remark</label>
                                                    <textarea class="form-control" id="remark" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary me-2" onclick="showList()">Cancel</button>
                                            <button type="submit" class="btn btn-primary px-4">Save Personnel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Import Pane -->
                        <div class="tab-pane fade" id="import-pane" role="tabpanel">
                             <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">Bulk Import</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row justify-content-center py-5">
                                        <div class="col-md-8 text-center">
                                            <div class="mb-4">
                                                <i class="bi bi-database-add text-success" style="font-size: 4rem;"></i>
                                                <p class="mt-2 text-muted">Upload an Excel (.xlsx, .xls) or MS Access (.accdb, .mdb) file.</p>
                                            </div>
                                            <div class="input-group mb-3">
                                                <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls, .accdb, .mdb">
                                                <button class="btn btn-primary" type="button" onclick="uploadExcel()">Upload & Import</button>
                                            </div>
                                            <div class="mb-4">
                                                <a href="/download/template" class="btn btn-outline-secondary btn-sm">
                                                    <i class="bi bi-download"></i> Download Excel Template
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="importResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>

                         <!-- Privileges Pane (Moved from Modal to here, or keep as separate tab) -->
                        <div class="tab-pane fade" id="privileges-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Manage User Privileges</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Rank</th>
                                                    <th>Current Role</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="privilegesTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Password Reset Pane -->
                        <div class="tab-pane fade" id="password-reset-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Reset User Passwords</h5>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <input type="text" id="resetSearchInput" class="form-control" placeholder="Search surname, NIS...">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" onclick="loadResetList()"><i class="bi bi-search"></i> Search</button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>NIS/No</th>
                                                    <th>Name</th>
                                                    <th>Rank</th>
                                                    <th>Office</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resetTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Offices View -->
                <div id="view-offices" class="view-section d-none">
                    <div class="card">
                         <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Offices Directory</h5>
                            <button class="btn btn-success" onclick="openOfficeModal()">
                                <i class="bi bi-plus-lg"></i> Add Office
                            </button>
                         </div>
                         <div class="card-body">
                             <div class="table-responsive">
                                 <table class="table table-hover align-middle">
                                     <thead class="table-light">
                                         <tr>
                                             <th>Office Name</th>
                                             <th style="width: 200px;">Actions</th>
                                         </tr>
                                     </thead>
                                     <tbody id="officesTableBody">
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Leave View -->
                <div id="view-leave" class="view-section d-none">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Leave Requests</h5>
                            <button class="btn btn-primary" onclick="openLeaveModal()">
                                <i class="bi bi-plus-lg"></i> Apply for Leave
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Staff Name</th>
                                            <th>Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Reason</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaveTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-audit" class="view-section d-none">
                     <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="card-title mb-0">System Audit Log</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Action</th>
                                            <th>Target</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success View -->
                <div id="view-success" class="view-section d-none">
                    <div class="card border-success">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                            <h2 class="mt-4">Update Successful!</h2>
                            <p class="lead text-muted">Your personnel information has been saved successfully.</p>
                            <div class="mt-4">
                                <button class="btn btn-primary px-4 me-2" onclick="showPersonnelTab('form-tab'); editStaff(userId)">Continue Editing</button>
                                <button class="btn btn-outline-danger px-4" onclick="logout()">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Office Modal -->
    <div class="modal fade" id="officeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="officeModalTitle">Add Office</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="officeId">
                    <div class="mb-3">
                        <label class="form-label required">Office Name</label>
                        <input type="text" class="form-control" id="officeName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOffice()">Save Office</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div class="modal fade" id="leaveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="leaveForm">
                        <div class="mb-3 d-none" id="leaveStaffSelectDiv">
                            <label class="form-label">Select Personnel</label>
                            <select class="form-select" id="leaveStaffId">
                                <option value="">Select Personnel...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Leave Type</label>
                            <select class="form-select" id="leaveType" required>
                                <option value="Annual">Annual Leave</option>
                                <option value="Casual">Casual Leave</option>
                                <option value="Sick">Sick Leave</option>
                                <option value="Compassionate">Compassionate Leave</option>
                                <option value="Maternity">Maternity Leave</option>
                                <option value="Paternity">Paternity Leave</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="text" class="form-control date-picker" id="leaveStartDate" required placeholder="dd/mm/yyyy">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="text" class="form-control date-picker" id="leaveEndDate" required placeholder="dd/mm/yyyy">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <textarea class="form-control" id="leaveReason" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitLeave()">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Columns Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Columns to Export</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="nis_no" id="col_nis_no" checked>
                                <label class="form-check-label" for="col_nis_no">NIS No</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="surname" id="col_surname" checked>
                                <label class="form-check-label" for="col_surname">Surname</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="other_names" id="col_other_names" checked>
                                <label class="form-check-label" for="col_other_names">Other Names</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="rank" id="col_rank" checked>
                                <label class="form-check-label" for="col_rank">Rank</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="gender" id="col_gender" checked>
                                <label class="form-check-label" for="col_gender">Gender</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="office" id="col_office" checked>
                                <label class="form-check-label" for="col_office">Office</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="state" id="col_state" checked>
                                <label class="form-check-label" for="col_state">State</label>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="merge_name">
                                <label class="form-check-label" for="merge_name">Merge Name (Surname + initials)</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="lga" id="col_lga" checked>
                                <label class="form-check-label" for="col_lga">LGA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="phone_no" id="col_phone_no" checked>
                                <label class="form-check-label" for="col_phone_no">Phone No</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="qualification" id="col_qualification">
                                <label class="form-check-label" for="col_qualification">Qualification</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="dob" id="col_dob">
                                <label class="form-check-label" for="col_dob">Date of Birth</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="dofa" id="col_dofa" checked>
                                <label class="form-check-label" for="col_dofa">DOFA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="dopa" id="col_dopa" checked>
                                <label class="form-check-label" for="col_dopa">DOPA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="dopp" id="col_dopp">
                                <label class="form-check-label" for="col_dopp">DOPP</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="exportType">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmExport()">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Out Modal -->
    <div class="modal fade" id="outModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark Staff as Out</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="outStaffId">
                    <div class="mb-3">
                        <label class="form-label">Reason / Mode</label>
                        <select class="form-select" id="outReason">
                            <option value="Posted Out">Posted Out</option>
                            <option value="Retired">Retired</option>
                            <option value="Deceased">Deceased</option>
                            <option value="Dismissed">Dismissed</option>
                            <option value="Resigned">Resigned</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Effective Date</label>
                        <input type="text" class="form-control date-picker" id="outDate" placeholder="dd/mm/yyyy">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmOut()">Confirm Exit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Exit Modal -->
    <div class="modal fade" id="reviewExitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Review Exit Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reviewStaffId">
                    <p>An office admin has requested to exit this personnel.</p>
                    <div class="alert alert-info" id="reviewExitDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="processExitRequest('reject')">Reject</button>
                    <button type="button" class="btn btn-success" onclick="processExitRequest('approve')">Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label required">Old Password</label>
                            <input type="password" class="form-control" id="cpOldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">New Password</label>
                            <input type="password" class="form-control" id="cpNewPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Confirm New Password</label>
                            <input type="password" class="form-control" id="cpConfirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Global Fetch Interceptor for 401 handling
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const [resource, config] = args;
            const response = await originalFetch(resource, config);
            
            if (response.status === 401) {
                const url = typeof resource === 'string' ? resource : resource.url;
                // Determine if request is to our backend (relative or same origin)
                const isAbsolute = url.startsWith('http://') || url.startsWith('https://');
                const isMyHost = isAbsolute ? url.includes(window.location.host) : true;
                
                if (isMyHost) {
                    console.warn('Session expired (401). Redirecting to login...');
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
            }
            return response;
        };

        // API Base URL
        const API_URL = ""; 

        // State Management
        let allStates = [];
        let outModal;
        let leaveModal;
        let exportModal;
        let changePasswordModal;
        let currentStatusFilter = 'completed'; // Default to completed
        let currentStatus = 'active'; // 'active' or 'exited'
        let userId = localStorage.getItem('userId');
        let currentOfficeName = '';
        const RANKS = [
            "DCG", "ACG", "CIS", "DCI", "ACI", "CSI", "SI", "DSI",
            "ASI 1", "ASI 2", "II", "AII", "IA 1", "IA 2", "IA 3"
        ];
        
        // DOM Elements - Sidebar removed
        
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username');
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/login.html';
        }

        document.getElementById('userDisplayNavbar').textContent = `${role === 'staff' ? 'Staff' : 'Admin'}: ${username}`;

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // View Navigation
        function showView(viewId) {
            if (viewId === 'offices' && role === 'office_admin') {
                alert('Permission denied');
                return;
            }
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
            // Show target view
            document.getElementById(`view-${viewId}`).classList.remove('d-none');
            
            // Update Title
            const titles = {
                'dashboard': 'Dashboard',
                'personnel': 'Personnel Management',
                'offices': 'Offices Directory',
                'leave': 'Leave Management',
                'audit': 'Audit Logs',
                'success': 'Action Successful'
            };
            document.getElementById('pageTitle').textContent = titles[viewId] || 'VSS Admin';

            // Trigger loads
            if(viewId === 'dashboard') loadDashboardStats();
            if(viewId === 'offices') loadOfficesView();
            if(viewId === 'audit') loadAuditLogs();
            if(viewId === 'leave') loadLeaveRequests();
            if(viewId === 'personnel') {
                // If coming to personnel, maybe refresh list?
                // loadStaff(); // Optional
            }
        }

        function showPersonnelTab(tabId) {
            showView('personnel');
            const tabEl = document.getElementById(tabId);
            if (tabEl) {
                const tab = new bootstrap.Tab(tabEl);
                tab.show();
            }
        }

        function showPrivileges() {
            showPersonnelTab('privileges-tab');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Init Form Listener (Highest Priority)
            const staffForm = document.getElementById('staffForm');
            if (staffForm) {
                // Ensure no duplicates and force handleFormSubmit
                staffForm.removeEventListener('submit', handleFormSubmit);
                staffForm.addEventListener('submit', handleFormSubmit);
            }

            // Init Common Data
            populateRanks();
            await fetchStates();
            await loadOffices(); // For dropdown

            // Init Modals
            const outEl = document.getElementById('outModal');
            if (outEl) outModal = new bootstrap.Modal(outEl);
            
            const expEl = document.getElementById('exportModal');
            if (expEl) exportModal = new bootstrap.Modal(expEl);
            
            const reviewEl = document.getElementById('reviewExitModal');
            if (reviewEl) reviewExitModal = new bootstrap.Modal(reviewEl);

            const cpEl = document.getElementById('changePasswordModal');
            if (cpEl) changePasswordModal = new bootstrap.Modal(cpEl);

            // Init DatePickers
            flatpickr(".date-picker", {
                dateFormat: "d/m/Y",
                allowInput: true
            });

            // Listen for tab changes to load specific data
            const privilegesTab = document.getElementById('privileges-tab');
            if(privilegesTab) {
                privilegesTab.addEventListener('shown.bs.tab', loadPrivileges);
            }
            
            const resetTab = document.getElementById('password-reset-tab');
            if(resetTab) {
                resetTab.addEventListener('shown.bs.tab', loadResetList);
            }

             // Role Based UI
            if (role === 'staff') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('d-none'));
                
                // Show form view directly
                showView('personnel');
                
                // Show form tab
                const formTabBtn = document.getElementById('form-tab');
                formTabBtn.classList.remove('d-none');
                const formTab = new bootstrap.Tab(formTabBtn);
                formTab.show();
                
                // Hide list tab navigation and cancel button
                const listTabBtn = document.getElementById('list-tab');
                if(listTabBtn) listTabBtn.parentElement.classList.add('d-none');
                const cancelBtn = document.querySelector('#staffForm button[onclick="showList()"]');
                if(cancelBtn) cancelBtn.classList.add('d-none');
                
                const doppInput = document.getElementById('dopp');
                if (doppInput) {
                    doppInput.disabled = true;
                    doppInput.placeholder = 'Locked';
                }
                
                // Load own data if userId exists
                if(userId) {
                     await editStaff(userId);
                }
                
                return;
            } else if (role === 'office_admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('d-none'));
                await fetchUserOffice();
            }

            loadStaff();

            // Default View
            showView('dashboard');
        });

        // Dashboard Logic
        async function fetchUserOffice() {
            if (role !== 'office_admin') return;
            try {
                const res = await fetch(`${API_URL}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    currentOfficeName = data.office_name;
                }
            } catch(e) { console.error("Failed to fetch office info", e); }
        }

        async function loadDashboardStats() {
            try {
                const res = await fetch(`${API_URL}/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const data = await res.json();
                    const card1Title = document.getElementById('dash-card1-title');
                    const card2Title = document.getElementById('dash-card2-title');
                    const card2Text = document.getElementById('dash-card2-text');

                    if (role === 'office_admin') {
                        const officeName = data.office_name || 'Your Office';
                        if (card1Title) card1Title.textContent = `Total Personnel (${officeName})`;
                        if (card2Title) card2Title.textContent = 'Office Name';
                        if (card2Text) card2Text.textContent = 'Your assigned office';

                        document.getElementById('dash-total-staff').textContent = data.total_staff ?? 0;
                        document.getElementById('dash-total-offices').textContent = data.office_name || '';
                    } else {
                        if (card1Title) card1Title.textContent = 'Total Personnel';
                        if (card2Title) card2Title.textContent = 'Total Offices';
                        if (card2Text) card2Text.textContent = 'Click to view offices';

                        document.getElementById('dash-total-staff').textContent = data.total_staff ?? 0;
                        document.getElementById('dash-total-offices').textContent = data.total_offices ?? 0;
                    }
                }
            } catch(e) { console.error(e); }
        }

        // Offices View Logic
        let officeModal; 

        document.addEventListener('DOMContentLoaded', () => {
             // ... (existing listeners)
             const officeEl = document.getElementById('officeModal');
             if (officeEl) officeModal = new bootstrap.Modal(officeEl);
        });

        async function loadOfficesView() {
            try {
                const res = await fetch(`${API_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const offices = await res.json();
                    const tbody = document.getElementById('officesTableBody');
                    tbody.innerHTML = '';
                    offices.forEach(off => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${off.name}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editOffice(${off.id}, ${JSON.stringify(off.name)})">Rename</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOffice(${off.id})">Remove</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    if (offices.length === 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td colspan="2" class="text-muted text-center">No offices found</td>`;
                        tbody.appendChild(tr);
                    }
                } else {
                    const tbody = document.getElementById('officesTableBody');
                    const data = await res.json().catch(() => ({}));
                    tbody.innerHTML = `<tr><td colspan="2" class="text-danger text-center">${data.detail || 'Failed to load offices'}</td></tr>`;
                }
            } catch(e) { console.error(e); }
        }

        function openOfficeModal() {
            document.getElementById('officeId').value = '';
            document.getElementById('officeName').value = '';
            document.getElementById('officeModalTitle').textContent = 'Add Office';
            officeModal.show();
        }

        function editOffice(id, name) {
            document.getElementById('officeId').value = id;
            document.getElementById('officeName').value = name;
            document.getElementById('officeModalTitle').textContent = 'Rename Office';
            officeModal.show();
        }

        async function saveOffice() {
            const id = document.getElementById('officeId').value;
            const name = document.getElementById('officeName').value;
            if(!name) return alert("Name is required");

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/offices/${id}` : `${API_URL}/offices`;
            
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });
                if(res.ok) {
                    officeModal.hide();
                    loadOfficesView();
                    loadOffices(); // Refresh dropdowns
                    loadDashboardStats(); // Refresh stats
                } else {
                    const data = await res.json().catch(() => ({}));
                    alert("Failed to save office: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        async function deleteOffice(id) {
            if(!confirm("Are you sure? This will remove the office from the system.")) return;
            try {
                const res = await fetch(`${API_URL}/offices/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    loadOfficesView();
                    loadOffices();
                    loadDashboardStats();
                } else {
                    alert("Failed to delete office");
                }
            } catch(e) { console.error(e); }
        }

        // --- EXISTING FUNCTIONS ADAPTED ---

        function pad2(n) { return String(n).padStart(2, '0'); }
        function isoToDmy(value) {
            if (!value) return '';
            const m = String(value).match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!m) return value; 
            return `${m[3]}/${m[2]}/${m[1]}`; 
        }
        function userDateToIsoOrNull(val) {
            if(!val) return null;
            const parts = val.split('/');
            if(parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`; 
            return null;
        }

        async function fetchStates() {
            try {
                const res = await fetch(`${API_URL}/states`);
                allStates = await res.json();
                const sel = document.getElementById('state_id');
                sel.innerHTML = '<option value="">Select State...</option>';
                allStates.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    sel.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }

        async function loadLGAs(stateId) {
            const lgaSel = document.getElementById('lga_id');
            lgaSel.innerHTML = '<option value="">Select LGA...</option>';
            lgaSel.disabled = true;
            if (!stateId) return;
            
            try {
                const res = await fetch(`${API_URL}/states/${stateId}/lgas`);
                if (res.ok) {
                    const lgas = await res.json();
                    lgas.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        lgaSel.appendChild(opt);
                    });
                    lgaSel.disabled = false;
                }
            } catch(e) { console.error(e); }
        }

        function populateRanks() {
            const sel = document.getElementById('rank');
            const filter = document.getElementById('filterRank');
            sel.innerHTML = '<option value="">Select...</option>';
            filter.innerHTML = '<option value="">All Ranks</option>';
            RANKS.forEach(r => {
                sel.add(new Option(r, r));
                filter.add(new Option(r, r));
            });
        }

        async function loadOffices() {
            // Populate Dropdown for filters and form
            // Reuse /offices endpoint
            try {
                const res = await fetch(`${API_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const offices = await res.json();
                    const formSel = document.getElementById('office');
                    const filterSel = document.getElementById('filterOffice');
                    
                    formSel.innerHTML = '<option value="">Select...</option>';
                    filterSel.innerHTML = '<option value="">All Offices</option>';
                    
                    offices.forEach(o => {
                         formSel.add(new Option(o.name, o.name));
                         filterSel.add(new Option(o.name, o.name));
                    });
                }
            } catch(e) { console.error(e); }
        }


        async function loadResetList() {
            const q = document.getElementById('resetSearchInput').value;
            let url = `${API_URL}/staff?limit=50`; // Default to active staff
            if (q) url += `&q=${encodeURIComponent(q)}`;
            
            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) throw new Error("Failed");
                const data = await res.json();
                renderResetTable(data);
            } catch (err) { console.error(err); }
        }

        function renderResetTable(data) {
             const tbody = document.getElementById('resetTableBody');
             tbody.innerHTML = '';
             data.forEach(s => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                     <td>${s.nis_no}</td>
                     <td>${s.surname} ${s.other_names}</td>
                     <td>${s.rank}</td>
                     <td>${s.office || ''}</td>
                     <td>
                         <button class="btn btn-sm btn-secondary me-1" onclick="resetUserPassword(${s.id})">Reset Pwd</button>
                         <button class="btn btn-sm btn-warning" onclick="resetUserLogin(${s.id})">Reset Login</button>
                     </td>
                 `;
                 tbody.appendChild(tr);
             });
        }

        async function loadStaff() {
            const q = document.getElementById('searchInput').value;
            const r = document.getElementById('filterRank').value;
            const o = document.getElementById('filterOffice').value;
            
            let url = `${API_URL}/staff?limit=100`;
            if (q) url += `&q=${encodeURIComponent(q)}`;
            if (r) url += `&rank=${encodeURIComponent(r)}`;
            if (o) url += `&office=${encodeURIComponent(o)}`;
            if (currentStatusFilter) url += `&completeness=${currentStatusFilter}`;
            if (currentStatus) url += `&status=${currentStatus}`;

            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!res.ok) {
                     const errText = await res.text();
                     throw new Error(`Failed to load staff: ${res.status} ${errText}`);
                }
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error("Invalid data format received");
                renderTable(data);
            } catch (err) { 
                console.error(err); 
                document.getElementById('staffTableBody').innerHTML = `<tr><td colspan="9" class="text-danger text-center">Error loading data: ${err.message}</td></tr>`;
            }
        }

        function setMainStatus(status, el) {
            currentStatus = status;
            document.querySelectorAll('#mainStatusTabs .nav-link').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            loadStaff();
        }
        
        function setStatusFilter(status, el) {
            currentStatusFilter = status;
            document.querySelectorAll('#statusTabs .nav-link').forEach(a => a.classList.remove('active'));
            el.classList.add('active');
            loadStaff();
        }

        async function undoExit(id) {
            if(!confirm("Are you sure you want to undo this exit? The staff will be active again.")) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/undo-exit`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    alert("Exit undone successfully");
                    loadStaff();
                } else {
                    const data = await res.json();
                    alert("Failed: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        function renderTable(data) {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';
            data.forEach((s, index) => {
                const tr = document.createElement('tr');
                // Rank, DOPA, NIS sorting logic is handled by backend now
                
                const sName = s.state ? s.state.name : '';
                const lName = s.lga ? s.lga.name : '';
                const location = (sName && lName) ? `${sName} / ${lName}` : (sName || lName || '');
                
                const dofa = isoToDmy(s.dofa);
                const dopa = isoToDmy(s.dopa);
                // const dates = (dofa && dopa) ? `${dofa} / ${dopa}` : (dofa || dopa || '');
                const dofaStr = dofa ? `<span class="small-font">${dofa}</span>` : '';
                const dopaStr = dopa ? dopa : '';
                const separator = (dofa && dopa) ? ' / ' : '';
                const dates = `${dofaStr}${separator}${dopaStr}`;

                let actionBtns = ``;

                if (currentStatus === 'exited') {
                     if (role === 'super_admin') {
                         actionBtns += `<button class="btn btn-sm btn-info mb-1" onclick="undoExit(${s.id})">Undo Exit</button>`;
                     } else {
                        actionBtns += `<span class="badge bg-secondary">Posted Out</span>`;
                     }
                } else {
                    actionBtns += `<button class="btn btn-sm btn-primary mb-1" onclick="editStaff(${s.id})">Edit</button>`;

                    if (role === 'super_admin') {
                         actionBtns += `<button class="btn btn-sm btn-danger mb-1" onclick="deleteStaff(${s.id})">Del</button>`;
                    }
                    
                    if (s.out_request_status === 'Pending') {
                        if (role === 'super_admin') {
                             actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openReviewExitModal(${s.id}, '${s.out_request_date}', '${s.out_request_reason}')">Review Exit</button>`;
                        } else {
                             actionBtns += `<span class="badge bg-warning text-dark">Exit Pending</span>`;
                        }
                    } else {
                        actionBtns += `<button class="btn btn-sm btn-warning mb-1" onclick="openOutModal(${s.id})">Out</button>`;
                    }
                }

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${s.nis_no}</td>
                    <td>${s.surname} ${s.other_names}</td>
                    <td>${s.rank}</td>
                    <td>${dates}</td>
                    <td>${s.office || ''}</td>
                    <td>${location}</td>
                    <td>${s.phone_no || ''}</td>
                    <td>${actionBtns}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            console.log("Submitting form..."); // Debug

            const id = document.getElementById('staffId').value;
            
            const payload = {
                nis_no: document.getElementById('nis_no').value,
                surname: document.getElementById('surname').value,
                other_names: document.getElementById('other_names').value,
                rank: document.getElementById('rank').value,
                gender: document.getElementById('gender').value,
                dob: userDateToIsoOrNull(document.getElementById('dob').value),
                phone_no: document.getElementById('phone_no').value,
                qualification: document.getElementById('qualification').value,
                
                office: document.getElementById('office').value,
                dofa: userDateToIsoOrNull(document.getElementById('dofa').value),
                dopa: userDateToIsoOrNull(document.getElementById('dopa').value),
                dopp: userDateToIsoOrNull(document.getElementById('dopp').value),
                
                state_id: document.getElementById('state_id').value || null,
                lga_id: document.getElementById('lga_id').value || null,
                home_town: document.getElementById('home_town').value,
                next_of_kin: document.getElementById('next_of_kin').value,
                nok_phone: document.getElementById('nok_phone').value,
                remark: document.getElementById('remark').value,
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/staff/${id}` : `${API_URL}/staff`;

            try {
                const currentRole = localStorage.getItem('role');
                if (currentRole === 'staff') {
                    delete payload.dopp;
                }
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    if (currentRole === 'staff') {
                         console.log("Showing success view for staff");
                         showView('success');
                    } else {
                        alert('Saved Successfully');
                        document.getElementById('staffForm').reset();
                        document.getElementById('staffId').value = '';
                        showList();
                        loadStaff();
                    }
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || JSON.stringify(err)));
                }
            } catch (err) {
                console.error(err);
                alert('Request failed');
            }
        }

        async function editStaff(id) {
            try {
                const res = await fetch(`${API_URL}/staff/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const s = await res.json();
                
                document.getElementById('staffId').value = s.id;
                document.getElementById('nis_no').value = s.nis_no;
                document.getElementById('surname').value = s.surname;
                document.getElementById('other_names').value = s.other_names;
                document.getElementById('rank').value = s.rank;
                document.getElementById('gender').value = s.gender;
                document.getElementById('dob').value = isoToDmy(s.dob);
                document.getElementById('phone_no').value = s.phone_no;
                document.getElementById('qualification').value = s.qualification;
                
                // For office, we might need to add it to options if not present
                const officeSel = document.getElementById('office');
                if(s.office && !Array.from(officeSel.options).some(o=>o.value===s.office)) {
                    officeSel.add(new Option(s.office, s.office));
                }
                officeSel.value = s.office || "";
                if (role === 'office_admin') {
                    officeSel.disabled = true;
                } else {
                    officeSel.disabled = false;
                }

                document.getElementById('dofa').value = isoToDmy(s.dofa);
                document.getElementById('dopa').value = isoToDmy(s.dopa);
                document.getElementById('dopp').value = isoToDmy(s.dopp);
                
                document.getElementById('state_id').value = s.state ? s.state.id : "";
                if (s.state && s.state.id) {
                    await loadLGAs(s.state.id);
                    document.getElementById('lga_id').value = s.lga ? s.lga.id : "";
                } else {
                    document.getElementById('lga_id').innerHTML = '<option value="">Select LGA...</option>';
                }
                
                document.getElementById('home_town').value = s.home_town || "";
                document.getElementById('next_of_kin').value = s.next_of_kin || "";
                document.getElementById('nok_phone').value = s.nok_phone || "";
                document.getElementById('remark').value = s.remark || "";
                
                showAddForm(true);
                document.getElementById('formTitle').textContent = "Edit Personnel";
            } catch (err) { console.error(err); }
        }

        function showList() {
            const listTab = new bootstrap.Tab(document.getElementById('list-tab'));
            listTab.show();
            document.getElementById('formTitle').textContent = "Add New Personnel";
            document.getElementById('staffId').value = '';
            document.getElementById('staffForm').reset();
        }

        async function showAddForm(isEdit = false) {
            const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
            formTab.show();
            
            if (!isEdit) {
                document.getElementById('staffForm').reset();
                document.getElementById('staffId').value = '';
                document.getElementById('formTitle').textContent = "Add New Personnel";
            }

            // If office admin, pre-select office
            if (role === 'office_admin') {
                if (!currentOfficeName) await fetchUserOffice();
                
                if (currentOfficeName) {
                    const officeSel = document.getElementById('office');
                    // Add option if not exists
                    if(!Array.from(officeSel.options).some(o=>o.value===currentOfficeName)) {
                        officeSel.add(new Option(currentOfficeName, currentOfficeName));
                    }
                    if (!isEdit) {
                        officeSel.value = currentOfficeName;
                    }
                    officeSel.disabled = true;
                }
            }
        }

        async function deleteStaff(id) {
            if (!confirm('Are you sure you want to delete this personnel?')) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadStaff();
                } else {
                    alert('Failed to delete');
                }
            } catch (err) { console.error(err); }
        }

        // Import
        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files[0]) {
                alert("Please select a file");
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const res = await fetch(`${API_URL}/import/excel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                let result;
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    result = await res.json();
                } else {
                    result = { detail: await res.text() };
                }

                const resDiv = document.getElementById('importResult');
                resDiv.innerHTML = `<div class="alert alert-${res.ok ? 'success':'danger'}">
                    ${result.detail || `Imported: ${result.imported_count}, Errors: ${result.errors ? result.errors.length : 0}`}
                </div>`;
                if (res.ok) loadStaff();
            } catch (err) {
                console.error(err);
                alert("Upload failed: " + err.message);
            }
        }
        
        function openExportModal(type) {
            document.getElementById('exportType').value = type;
            exportModal.show();
        }

        function confirmExport() {
            const type = document.getElementById('exportType').value;
            const checkboxes = document.querySelectorAll('#exportModal input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).filter(cb => cb.id !== 'merge_name').map(cb => cb.value);
            const mergeName = document.getElementById('merge_name').checked;
            
            if (selected.length === 0) {
                alert("Please select at least one column");
                return;
            }
            
            exportData(type, selected, mergeName);
            exportModal.hide();
        }

        async function exportData(type, columns, mergeName) {
            const q = document.getElementById('searchInput').value;
            const r = document.getElementById('filterRank').value;
            const o = document.getElementById('filterOffice').value;
            const c = currentStatusFilter;
            
            const params = new URLSearchParams();
            if (q) params.append('q', q);
            if (r) params.append('rank', r);
            if (o) params.append('office', o);
            if (c) params.append('completeness', c);
            if (columns && columns.length) params.append('columns', columns.join(','));
            if (mergeName) params.append('merge_name', '1');

            const url = `${API_URL}/export/${type}?${params.toString()}`;
            
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    let msg = 'Export failed';
                    try {
                        const err = await res.json();
                        if (err && err.detail) msg = err.detail;
                    } catch(e) {}
                    alert(msg);
                    return;
                }
                const blob = await res.blob();
                const disposition = res.headers.get('Content-Disposition') || '';
                let filename = '';
                const match = disposition.match(/filename="?([^"]+)"?/i);
                if (match && match[1]) filename = match[1];
                if (!filename) {
                    const ext = type === 'pdf' ? 'pdf' : 'xlsx';
                    filename = `staff_export_${new Date().toISOString().slice(0,10)}.${ext}`;
                }
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                console.error(e);
                alert('Export failed: ' + e.message);
            }
        }

        async function loadAuditLogs() {
            try {
                const res = await fetch(`${API_URL}/audit-logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const logs = await res.json();
                    const tbody = document.getElementById('auditTableBody');
                    tbody.innerHTML = '';
                    logs.forEach(l => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${new Date(l.timestamp).toLocaleString()}</td>
                            <td>${l.action}</td>
                            <td>${l.target}</td>
                            <td>${l.details || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); }
        }

        function openOutModal(id) {
            document.getElementById('outStaffId').value = id;
            document.getElementById('outReason').value = 'Posted Out';
            document.getElementById('outDate').value = '';
            outModal.show();
        }

        async function confirmOut() {
            const id = document.getElementById('outStaffId').value;
            const reason = document.getElementById('outReason').value;
            const dateStr = document.getElementById('outDate').value;
            
            if (!dateStr) {
                alert("Please select a date");
                return;
            }

            if (!confirm(`Are you sure you want to mark this personnel as ${reason}?`)) return;

            const isRequest = (role === 'office_admin');
            const url = isRequest ? `${API_URL}/staff/${id}/exit-request` : `${API_URL}/staff/${id}`; // Super admin uses direct update for now, or we can use exit-request for them too?
            // Actually, existing logic used PUT /staff/{id}.
            // For office_admin, we use POST /staff/{id}/exit-request
            
            try {
                let res;
                if (isRequest) {
                     res = await fetch(`${API_URL}/staff/${id}/exit-request`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ exit_date: dateStr, exit_mode: reason })
                    });
                } else {
                     // Super admin direct update (legacy way, or we can use new endpoints?)
                     // Use legacy PUT for super admin direct exit
                     res = await fetch(`${API_URL}/staff/${id}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ exit_date: dateStr, exit_mode: reason })
                    });
                }

                if (res.ok) {
                    alert(isRequest ? "Exit request submitted for approval" : "Personnel status updated successfully");
                    outModal.hide();
                    loadStaff(); 
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed to update"));
                }
            } catch (e) {
                console.error(e);
                alert("An error occurred");
            }
        }

        function openReviewExitModal(id, date, reason) {
            document.getElementById('reviewStaffId').value = id;
            document.getElementById('reviewExitDetails').textContent = `Reason: ${reason}, Effective: ${isoToDmy(date)}`;
            reviewExitModal.show();
        }

        async function processExitRequest(action) {
            const id = document.getElementById('reviewStaffId').value;
            if(!confirm(`Are you sure you want to ${action} this request?`)) return;
            
            const endpoint = action === 'approve' ? 'exit-approve' : 'exit-reject';
            
            try {
                const res = await fetch(`${API_URL}/staff/${id}/${endpoint}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (res.ok) {
                    alert(`Request ${action}d successfully`);
                    reviewExitModal.hide();
                    loadStaff();
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed"));
                }
            } catch(e) { console.error(e); }
        }
        
        async function loadPrivileges() {
             try {
                const res = await fetch(`${API_URL}/staff?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Failed to fetch staff");
                const items = await res.json();
                
                const tbody = document.getElementById('privilegesTableBody');
                tbody.innerHTML = '';
                
                items.forEach(s => {
                    const tr = document.createElement('tr');
                    const isSuper = s.role === 'super_admin';
                    
                    tr.innerHTML = `
                        <td>${s.nis_no}</td>
                        <td>${s.surname} ${s.other_names}</td>
                        <td>${s.rank}</td>
                        <td><span class="badge bg-${s.role === 'super_admin' ? 'danger' : (s.role === 'office_admin' ? 'warning' : 'info')}">${s.role}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="updateRole(${s.id}, 'staff')" ${s.role === 'staff' ? 'disabled' : ''}>Staff</button>
                                <button class="btn btn-outline-warning" onclick="updateRole(${s.id}, 'office_admin')" ${s.role === 'office_admin' ? 'disabled' : ''}>Office Admin</button>
                                <button class="btn btn-outline-danger" onclick="updateRole(${s.id}, 'super_admin')" ${s.role === 'super_admin' ? 'disabled' : ''}>Super Admin</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }
        
        async function updateRole(id, newRole) {
            if(!confirm(`Change role to ${newRole}?`)) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if(res.ok) {
                    loadPrivileges();
                } else {
                    alert('Failed to update role');
                }
            } catch(e) { console.error(e); }
        }

        // Leave Management
        async function loadLeaveRequests() {
            try {
                const res = await fetch(`${API_URL}/leaves`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const items = await res.json();
                    const tbody = document.getElementById('leaveTableBody');
                    tbody.innerHTML = '';
                    items.forEach(l => {
                        const tr = document.createElement('tr');
                        // Action buttons based on status and role
                        let actions = '';
                        if(role === 'super_admin' || role === 'office_admin') {
                            if(l.status === 'Pending') {
                                actions = `
                                    <button class="btn btn-sm btn-success" onclick="updateLeaveStatus(${l.id}, 'Approved')">Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="updateLeaveStatus(${l.id}, 'Rejected')">Reject</button>
                                `;
                            }
                        }
                        
                        tr.innerHTML = `
                            <td>${l.staff_name}</td>
                            <td>${l.leave_type}</td>
                            <td>${isoToDmy(l.start_date)}</td>
                            <td>${isoToDmy(l.end_date)}</td>
                            <td>${l.reason || ''}</td>
                            <td><span class="badge bg-${l.status === 'Approved' ? 'success' : (l.status === 'Rejected' ? 'danger' : 'warning')}">${l.status}</span></td>
                            <td>${actions}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function openLeaveModal() {
            document.getElementById('leaveForm').reset();
            
            // If admin, load staff list
            if(role !== 'staff') {
                document.getElementById('leaveStaffSelectDiv').classList.remove('d-none');
                await loadAllStaffForSelect();
            } else {
                document.getElementById('leaveStaffSelectDiv').classList.add('d-none');
            }

            if(!leaveModal) {
                 leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
            }
            leaveModal.show();
        }

        async function loadAllStaffForSelect() {
            const sel = document.getElementById('leaveStaffId');
            if(sel.options.length > 1) return; // Already loaded

            try {
                const res = await fetch(`${API_URL}/staff?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    const items = await res.json();
                    items.forEach(s => {
                        const opt = new Option(`${s.surname} ${s.other_names} (${s.nis_no})`, s.id);
                        sel.add(opt);
                    });
                }
            } catch(e) { console.error(e); }
        }

        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            const staffId = document.getElementById('leaveStaffId').value;
            
            if(!type || !start || !end) {
                alert("Please fill required fields");
                return;
            }
            
            // Convert dd/mm/yyyy to yyyy-mm-dd
            const isoStart = userDateToIsoOrNull(start);
            const isoEnd = userDateToIsoOrNull(end);

            if(!isoStart || !isoEnd) {
                 alert("Invalid date format");
                 return;
            }

            const payload = {
                leave_type: type,
                start_date: isoStart,
                end_date: isoEnd,
                reason: reason
            };
            
            if(role !== 'staff') {
                if(!staffId) {
                    alert("Please select personnel");
                    return;
                }
                payload.staff_id = parseInt(staffId);
            }

            try {
                const res = await fetch(`${API_URL}/leaves`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    alert("Leave request submitted");
                    leaveModal.hide();
                    loadLeaveRequests();
                } else {
                    const err = await res.json();
                    alert("Error: " + (err.detail || "Failed"));
                }
            } catch(e) { console.error(e); }
        }

        async function updateLeaveStatus(id, status) {
            if(!confirm(`Mark leave as ${status}?`)) return;
            try {
                 const res = await fetch(`${API_URL}/leaves/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ status: status })
                });
                if(res.ok) {
                    loadLeaveRequests();
                } else {
                    alert("Failed to update status");
                }
            } catch(e) { console.error(e); }
        }

        async function resetUserPassword(id) {
             if(!confirm("Reset password to default (NIS Number)?")) return;
             try {
                 const res = await fetch(`${API_URL}/staff/${id}/reset-password`, {
                     method: 'POST',
                     headers: { 'Authorization': `Bearer ${token}` }
                 });
                 if(res.ok) {
                     alert("Password reset successfully");
                 } else {
                     alert("Failed to reset password");
                 }
             } catch(e) { console.error(e); }
        }

        async function resetUserLogin(id) {
            if(!confirm("Reset login count for this user? They will be allowed to log in again.")) return;
            try {
                const res = await fetch(`${API_URL}/staff/${id}/reset-login`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    alert("Login count reset successfully");
                } else {
                    const data = await res.json();
                    alert("Failed: " + (data.detail || "Unknown error"));
                }
            } catch(e) { console.error(e); }
        }

        function openChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            changePasswordModal.show();
        }

        async function submitChangePassword() {
            const oldPwd = document.getElementById('cpOldPassword').value;
            const newPwd = document.getElementById('cpNewPassword').value;
            const confirmPwd = document.getElementById('cpConfirmPassword').value;

            if(!oldPwd || !newPwd || !confirmPwd) {
                alert("All fields are required");
                return;
            }
            if(newPwd !== confirmPwd) {
                alert("New passwords do not match");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        old_password: oldPwd,
                        new_password: newPwd
                    })
                });

                const data = await res.json();
                if(res.ok) {
                    alert("Password changed successfully");
                    changePasswordModal.hide();
                } else {
                    alert("Error: " + (data.detail || "Failed to change password"));
                }
            } catch(e) {
                console.error(e);
                alert("Request failed");
            }
        }
    </script>
</body>
</html>
